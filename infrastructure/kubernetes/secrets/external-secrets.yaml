# ExternalSecret Resources — Third-Party Service Secrets
# Story: 0-22 Third-Party Service Accounts & API Keys
# AC: 12 - ExternalSecrets syncs secrets to Kubernetes namespaces
#
# These ExternalSecret resources sync secrets from the cloud secret store
# (AWS Secrets Manager or Azure Key Vault) into Kubernetes Secrets.
#
# Usage:
#   AWS:   kubectl apply -f external-secrets.yaml  (uses aws-secrets-manager ClusterSecretStore)
#   Azure: Edit secretStoreRef.name to "azure-key-vault" and remoteRef.key to KV names
#
# Namespace: Apply once per namespace (staging, production).
#   kubectl apply -n staging -f external-secrets.yaml
#   kubectl apply -n production -f external-secrets.yaml

---
# =============================================================================
# LLM — OpenAI API Key (AC1)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: openai-api-key
  labels:
    app.kubernetes.io/part-of: qualisys
    qualisys/category: llm
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: openai-api-key
    creationPolicy: Owner
  data:
    - secretKey: api-key
      remoteRef:
        key: qualisys/llm/openai
        property: api_key

---
# =============================================================================
# LLM — Anthropic API Key (AC2)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: anthropic-api-key
  labels:
    app.kubernetes.io/part-of: qualisys
    qualisys/category: llm
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: anthropic-api-key
    creationPolicy: Owner
  data:
    - secretKey: api-key
      remoteRef:
        key: qualisys/llm/anthropic
        property: api_key

---
# =============================================================================
# Auth — Google OAuth Credentials (AC3)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: google-oauth
  labels:
    app.kubernetes.io/part-of: qualisys
    qualisys/category: oauth
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: google-oauth
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: qualisys/oauth/google

---
# =============================================================================
# Email — SendGrid API Key (AC4)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: sendgrid-api-key
  labels:
    app.kubernetes.io/part-of: qualisys
    qualisys/category: email
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: sendgrid-api-key
    creationPolicy: Owner
  data:
    - secretKey: api-key
      remoteRef:
        key: qualisys/email/sendgrid
        property: api_key

---
# =============================================================================
# Integrations — GitHub App (AC7)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: github-app
  labels:
    app.kubernetes.io/part-of: qualisys
    qualisys/category: integrations
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: github-app
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: qualisys/integrations/github-app

---
# =============================================================================
# Integrations — Jira API Token (AC5)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jira-api-token
  labels:
    app.kubernetes.io/part-of: qualisys
    qualisys/category: integrations
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: jira-api-token
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: qualisys/integrations/jira

---
# =============================================================================
# Integrations — Slack Webhook (AC6)
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: slack-webhook
  labels:
    app.kubernetes.io/part-of: qualisys
    qualisys/category: integrations
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: slack-webhook
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: qualisys/integrations/slack-webhook

---
# =============================================================================
# JWT Signing Key
# =============================================================================
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-signing-key
  labels:
    app.kubernetes.io/part-of: qualisys
    qualisys/category: jwt
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: jwt-signing-key
    creationPolicy: Owner
  dataFrom:
    - extract:
        key: qualisys/jwt/signing-key
