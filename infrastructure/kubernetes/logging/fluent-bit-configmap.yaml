# Fluent Bit Configuration — Log Shipping to CloudWatch / Azure Monitor
# Story: 0-20 Log Aggregation
# AC: 2 - API logs shipped to central system
# AC: 3 - Worker logs shipped
# AC: 4 - Kubernetes system logs collected
# AC: 5 - Logs structured in JSON format
# AC: 11 - PII redaction enabled
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: monitoring
  labels:
    app: fluent-bit
    app.kubernetes.io/name: fluent-bit
    app.kubernetes.io/part-of: qualisys-logging
data:
  # -----------------------------------------------------------------------
  # Main Fluent Bit configuration (Task 2.2, 2.3, 2.5)
  # -----------------------------------------------------------------------
  fluent-bit.conf: |
    [SERVICE]
        Flush         5
        Log_Level     info
        Daemon        off
        Parsers_File  parsers.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020

    # Collect container logs (AC2, AC3, AC4)
    [INPUT]
        Name              tail
        Tag               kube.*
        Path              /var/log/containers/*.log
        Parser            docker
        DB                /var/log/flb_kube.db
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On
        Refresh_Interval  10

    # Kubernetes metadata enrichment
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Merge_Log           On
        Keep_Log            Off
        K8S-Logging.Parser  On
        K8S-Logging.Exclude On

    # Add service identifier
    [FILTER]
        Name          modify
        Match         kube.*
        Rename        log message
        Add           service qualisys

    # Multiline stack trace parsing (Task 2.5)
    [FILTER]
        Name          multiline
        Match         kube.*
        multiline.key_content message
        multiline.parser      java_stacktrace, python_stacktrace

    # PII Redaction (AC11 — Task 4.1, 4.2, 4.3)
    [FILTER]
        Name          lua
        Match         *
        script        /fluent-bit/scripts/pii-redact.lua
        call          redact_pii

    # Output: Staging API logs to CloudWatch (AC2)
    # K8s log path: <pod>_<namespace>_<container>.log — match on _staging_
    [OUTPUT]
        Name                cloudwatch_logs
        Match               kube.var.log.containers.qualisys-api-*_staging_*
        region              ${AWS_REGION}
        log_group_name      /qualisys/staging/api
        log_stream_prefix   ${POD_NAME}-
        auto_create_group   false

    # Output: Production API logs to CloudWatch (AC2)
    [OUTPUT]
        Name                cloudwatch_logs
        Match               kube.var.log.containers.qualisys-api-*_production_*
        region              ${AWS_REGION}
        log_group_name      /qualisys/production/api
        log_stream_prefix   ${POD_NAME}-
        auto_create_group   false

    # Output: Staging Worker logs to CloudWatch (AC3)
    [OUTPUT]
        Name                cloudwatch_logs
        Match               kube.var.log.containers.qualisys-worker-*_staging_*
        region              ${AWS_REGION}
        log_group_name      /qualisys/staging/worker
        log_stream_prefix   ${POD_NAME}-
        auto_create_group   false

    # Output: Production Worker logs to CloudWatch (AC3)
    [OUTPUT]
        Name                cloudwatch_logs
        Match               kube.var.log.containers.qualisys-worker-*_production_*
        region              ${AWS_REGION}
        log_group_name      /qualisys/production/worker
        log_stream_prefix   ${POD_NAME}-
        auto_create_group   false

    # Output: Kubernetes system logs (AC4)
    [OUTPUT]
        Name                cloudwatch_logs
        Match               kube.var.log.containers.kube-*
        region              ${AWS_REGION}
        log_group_name      /qualisys/kubernetes/system
        log_stream_prefix   ${NODE_NAME}-
        auto_create_group   false

  # -----------------------------------------------------------------------
  # Log parsers (AC5 — JSON structured format)
  # -----------------------------------------------------------------------
  parsers.conf: |
    [PARSER]
        Name        docker
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep   On

    [PARSER]
        Name        json
        Format      json
        Time_Key    timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%LZ

    [MULTILINE_PARSER]
        name          java_stacktrace
        type          regex
        flush_timeout 1000
        rule          "start_state"  "/^[^\s]/"               "cont"
        rule          "cont"         "/^\s+(at|Caused by|\.{3})/" "cont"

    [MULTILINE_PARSER]
        name          python_stacktrace
        type          regex
        flush_timeout 1000
        rule          "start_state"  "/^Traceback/"           "cont"
        rule          "cont"         "/^\s+/"                 "cont"

  # -----------------------------------------------------------------------
  # PII Redaction Lua Script (AC11 — Task 4.1, 4.2, 4.3)
  # -----------------------------------------------------------------------
  pii-redact.lua: |
    -- PII Redaction Filter for Fluent Bit
    -- Masks email addresses and user names in log messages

    function redact_pii(tag, timestamp, record)
      local modified = false

      -- AC11 / Task 4.2: Redact email addresses (user@***.com)
      if record["message"] and type(record["message"]) == "string" then
        local new_msg = string.gsub(record["message"],
          "([%w%.%-]+)@([%w%.%-]+%.%w+)",
          function(local_part, domain)
            modified = true
            local tld = string.match(domain, "%.(%w+)$")
            return local_part:sub(1,1) .. "***@***." .. (tld or "***")
          end)
        if modified then
          record["message"] = new_msg
        end
      end

      -- AC11 / Task 4.3: Redact user_name field (John D***)
      if record["user_name"] and type(record["user_name"]) == "string" then
        local name = record["user_name"]
        if #name > 3 then
          -- Keep first name initial + mask remainder
          local space_pos = string.find(name, " ")
          if space_pos then
            local first = string.sub(name, 1, space_pos)
            local last = string.sub(name, space_pos + 1)
            record["user_name"] = first .. string.sub(last, 1, 1) .. string.rep("*", math.max(#last - 1, 3))
          else
            record["user_name"] = string.sub(name, 1, 1) .. string.rep("*", math.max(#name - 1, 3))
          end
          modified = true
        end
      end

      -- Redact email field if present
      if record["email"] and type(record["email"]) == "string" then
        local email = record["email"]
        local local_part, domain = string.match(email, "^([%w%.%-]+)@(.+)$")
        if local_part and domain then
          local tld = string.match(domain, "%.(%w+)$")
          record["email"] = local_part:sub(1,1) .. "***@***." .. (tld or "***")
          modified = true
        end
      end

      if modified then
        return 2, timestamp, record
      end
      return 0, timestamp, record
    end
