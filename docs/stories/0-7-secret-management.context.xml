<story-context id="bmad/bmm/workflows/4-implementation/story-context" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>7</storyId>
    <title>Secret Management</title>
    <status>ready-for-dev</status>
    <generatedAt>2026-01-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/0-7-secret-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>DevOps Engineer</asA>
    <iWant>configure a secret management system with rotation and audit logging</iWant>
    <soThat>we can securely store and access API keys, database passwords, and credentials across all environments</soThat>
    <tasks>
      <task id="1" name="Secrets Manager Setup" acs="1">
        <subtask>1.1-1.4 Verify availability, create KMS key, define naming convention, document</subtask>
      </task>
      <task id="2" name="Infrastructure Secrets Creation" acs="2,3,4">
        <subtask>2.1-2.5 Create database, redis, JWT secrets via Terraform</subtask>
      </task>
      <task id="3" name="Third-Party API Keys" acs="5,6,7">
        <subtask>3.1-3.5 Create LLM, OAuth, email secrets, document rotation schedule</subtask>
      </task>
      <task id="4" name="ExternalSecrets Operator Installation" acs="8,9">
        <subtask>4.1-4.6 Install operator, configure IRSA, create ExternalSecrets, verify sync</subtask>
      </task>
      <task id="5" name="Secret Rotation Configuration" acs="10">
        <subtask>5.1-5.5 Create Lambda rotation, configure schedule, test, document</subtask>
      </task>
      <task id="6" name="IAM and Audit Configuration" acs="11,12">
        <subtask>6.1-6.6 Create IAM policies, attach to roles, verify CloudTrail, create alarms</subtask>
      </task>
      <task id="7" name="Validation &amp; Documentation" acs="all">
        <subtask>7.1-7.6 Run verification, test retrieval, verify sync, document runbook</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">AWS Secrets Manager configured as primary secret store</ac>
    <ac id="2">Database connection string secret created and stored</ac>
    <ac id="3">Redis connection string secret created and stored</ac>
    <ac id="4">JWT signing secret created (256-bit random)</ac>
    <ac id="5">LLM API keys stored: OpenAI API key, Anthropic API key</ac>
    <ac id="6">OAuth credentials stored: Google OAuth client ID/secret</ac>
    <ac id="7">Email service API key stored (SendGrid/Postmark)</ac>
    <ac id="8">Kubernetes ExternalSecrets Operator installed and configured</ac>
    <ac id="9">ExternalSecrets sync secrets from AWS to Kubernetes</ac>
    <ac id="10">Secret rotation configured: database password every 90 days</ac>
    <ac id="11">Access audit logging enabled for all secrets</ac>
    <ac id="12">IAM policies restrict secret access to specific roles</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-specs/tech-spec-epic-0.md</path>
        <title>Epic 0 Technical Specification</title>
        <section>Services and Modules</section>
        <snippet>AWS Secrets Manager: Auto-rotation (90 days), audit logging. Secure storage for credentials, API keys, DB passwords.</snippet>
      </doc>
      <doc>
        <path>docs/tech-specs/tech-spec-epic-0.md</path>
        <title>Epic 0 Technical Specification</title>
        <section>Security Threat Model</section>
        <snippet>Secrets Management: No secrets in Git, no secrets baked into Docker images. Trivy secret scanning fails build if detected. Secret rotation prevents stale credentials.</snippet>
      </doc>
      <doc>
        <path>docs/tech-specs/tech-spec-epic-0.md</path>
        <title>Epic 0 Technical Specification</title>
        <section>Non-Functional Requirements - Security</section>
        <snippet>Secret rotation: Database passwords every 90 days. Access audit logging enabled (who accessed which secret when).</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-0-infrastructure.md</path>
        <title>Epic 0: Infrastructure Foundation</title>
        <section>Story 0.7</section>
        <snippet>Secret Management with Secrets Manager, ExternalSecrets Operator, rotation, audit logging. Dependencies: Story 0.1 (IAM), Story 0.3 (Kubernetes).</snippet>
      </doc>
      <doc>
        <path>docs/architecture/architecture.md</path>
        <title>System Architecture</title>
        <section>Security Architecture</section>
        <snippet>Centralized secret management via AWS Secrets Manager. Kubernetes integration via ExternalSecrets Operator. Audit trail for compliance.</snippet>
      </doc>
      <doc>
        <path>docs/stories/0-1-cloud-account-iam-setup.md</path>
        <title>Story 0.1: Cloud Account &amp; IAM Setup</title>
        <section>IAM Roles</section>
        <snippet>Prerequisite: IAM roles for IRSA (IAM Roles for Service Accounts) to enable ExternalSecrets Operator authentication.</snippet>
      </doc>
      <doc>
        <path>docs/stories/0-3-kubernetes-cluster-provisioning.md</path>
        <title>Story 0.3: Kubernetes Cluster Provisioning</title>
        <section>Outputs</section>
        <snippet>Prerequisite: cluster_oidc_provider_arn for IRSA configuration with ExternalSecrets Operator.</snippet>
      </doc>
      <doc>
        <path>docs/stories/0-4-postgresql-multi-tenant-database.md</path>
        <title>Story 0.4: PostgreSQL Multi-Tenant Database</title>
        <section>Secrets Manager Integration</section>
        <snippet>Input: Database connection string from Story 0.4 stored in qualisys/database/connection.</snippet>
      </doc>
      <doc>
        <path>docs/stories/0-5-redis-caching-layer.md</path>
        <title>Story 0.5: Redis Caching Layer</title>
        <section>Secrets Manager Integration</section>
        <snippet>Input: Redis connection info from Story 0.5 stored in qualisys/redis/connection.</snippet>
      </doc>
    </docs>

    <code>
      <note>Greenfield infrastructure - Stories 0.1, 0.3, 0.4, 0.5 provide foundation (all ready-for-dev).</note>
      <prerequisites>
        <story id="0-1-cloud-account-iam-setup" status="ready-for-dev">
          <provides>IAM roles for IRSA</provides>
        </story>
        <story id="0-3-kubernetes-cluster-provisioning" status="ready-for-dev">
          <provides>cluster_oidc_provider_arn for IRSA</provides>
        </story>
        <story id="0-4-postgresql-multi-tenant-database" status="ready-for-dev">
          <provides>Database connection string</provides>
        </story>
        <story id="0-5-redis-caching-layer" status="ready-for-dev">
          <provides>Redis connection info</provides>
        </story>
      </prerequisites>
      <expectedStructure>
        <folder path="infrastructure/terraform/secrets" purpose="Secrets Manager Terraform module" />
        <file path="infrastructure/terraform/secrets/main.tf" purpose="Secrets Manager secrets" />
        <file path="infrastructure/terraform/secrets/rotation.tf" purpose="Lambda rotation configuration" />
        <file path="infrastructure/terraform/secrets/iam.tf" purpose="Secret access IAM policies" />
        <file path="infrastructure/terraform/secrets/variables.tf" purpose="Secret variables" />
        <file path="infrastructure/terraform/secrets/outputs.tf" purpose="Secret ARNs" />
        <folder path="infrastructure/kubernetes/external-secrets" purpose="ExternalSecrets Operator" />
        <file path="infrastructure/kubernetes/external-secrets/values.yaml" purpose="Helm values" />
        <file path="infrastructure/kubernetes/external-secrets/cluster-secret-store.yaml" purpose="ClusterSecretStore" />
        <folder path="infrastructure/kubernetes/external-secrets/external-secrets" purpose="ExternalSecret resources" />
        <file path="infrastructure/README.md" purpose="Secret management documentation" />
      </expectedStructure>
      <outputs description="Resources exported for downstream stories and epics">
        <output name="database_secret_arn" consumers="Epic 1-6 (API pods)" />
        <output name="redis_secret_arn" consumers="Epic 1-6 (API pods)" />
        <output name="jwt_secret_arn" consumers="Epic 1 (authentication)" />
        <output name="openai_secret_arn" consumers="Epic 2 (AI agents)" />
        <output name="anthropic_secret_arn" consumers="Epic 2 (AI agents)" />
        <output name="oauth_secret_arn" consumers="Epic 1 (SSO)" />
        <output name="email_secret_arn" consumers="Epic 1 (notifications)" />
        <output name="secrets_read_infra_policy_arn" consumers="Application pod IAM roles" />
        <output name="secrets_read_llm_policy_arn" consumers="AI agent pod IAM roles" />
      </outputs>
      <secretNamingConvention>
        <pattern category="database" format="qualisys/database/{name}" example="qualisys/database/connection" />
        <pattern category="redis" format="qualisys/redis/{name}" example="qualisys/redis/connection" />
        <pattern category="jwt" format="qualisys/jwt/{name}" example="qualisys/jwt/signing-key" />
        <pattern category="llm" format="qualisys/llm/{provider}" example="qualisys/llm/openai" />
        <pattern category="oauth" format="qualisys/oauth/{provider}" example="qualisys/oauth/google" />
        <pattern category="email" format="qualisys/email/{provider}" example="qualisys/email/sendgrid" />
      </secretNamingConvention>
      <rotationSchedule>
        <rotation secret="database" period="90 days" method="Lambda rotation function" />
        <rotation secret="redis" period="Manual" method="Coordinate with ElastiCache" />
        <rotation secret="jwt" period="Annual" method="Manual with key versioning" />
        <rotation secret="llm" period="Quarterly" method="Manual (provider regeneration)" />
        <rotation secret="oauth" period="Annual" method="Manual (Google Cloud Console)" />
      </rotationSchedule>
    </code>

    <dependencies>
      <terraform>
        <provider name="aws" version="~&gt; 5.0" />
        <provider name="kubernetes" version="~&gt; 2.23" />
        <provider name="helm" version="~&gt; 2.11" />
      </terraform>
      <helmCharts>
        <chart name="external-secrets" repo="https://charts.external-secrets.io" version="~&gt; 0.9" />
      </helmCharts>
      <tools>
        <tool name="aws-cli" version="2.x" purpose="Secrets Manager verification" />
        <tool name="terraform" version="&gt;= 1.5.0" purpose="Infrastructure as Code" />
        <tool name="kubectl" version="1.28+" purpose="ExternalSecrets verification" />
        <tool name="helm" version="3.x" purpose="ExternalSecrets Operator installation" />
      </tools>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="Security" critical="true">No secrets in Git repositories - all secrets in Secrets Manager</constraint>
    <constraint source="Security" critical="true">No secrets baked into Docker images - applications retrieve at runtime</constraint>
    <constraint source="Security">All secrets encrypted with AWS KMS</constraint>
    <constraint source="Security">Least privilege IAM policies - separate policies per secret category</constraint>
    <constraint source="Security">IRSA required for ExternalSecrets Operator authentication</constraint>
    <constraint source="Compliance">CloudTrail audit logging for all secret access (NFR-SEC)</constraint>
    <constraint source="Operations">Database password rotation every 90 days</constraint>
    <constraint source="Dependency">Story 0.1 (IAM) and Story 0.3 (K8s) must be complete for IRSA</constraint>
    <constraint source="Dependency">Story 0.4 (DB) and Story 0.5 (Redis) provide connection strings</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>AWS Secrets Manager API</name>
      <kind>REST API (via Terraform aws provider)</kind>
      <signature>aws_secretsmanager_secret, aws_secretsmanager_secret_version, aws_secretsmanager_secret_rotation</signature>
      <path>infrastructure/terraform/secrets/main.tf</path>
    </interface>
    <interface>
      <name>AWS IAM API</name>
      <kind>REST API (via Terraform aws provider)</kind>
      <signature>aws_iam_policy for secrets-read-infra, secrets-read-llm, secrets-read-integrations</signature>
      <path>infrastructure/terraform/secrets/iam.tf</path>
    </interface>
    <interface>
      <name>AWS Lambda API</name>
      <kind>REST API (for rotation function)</kind>
      <signature>aws_lambda_function for database password rotation</signature>
      <path>infrastructure/terraform/secrets/rotation.tf</path>
    </interface>
    <interface>
      <name>ExternalSecrets Operator API</name>
      <kind>Kubernetes CRD</kind>
      <signature>ClusterSecretStore, ExternalSecret, SecretStore</signature>
      <path>infrastructure/kubernetes/external-secrets/</path>
    </interface>
    <interface>
      <name>Kubernetes Secrets API</name>
      <kind>Kubernetes API (synced by ExternalSecrets)</kind>
      <signature>Secret resources in application namespaces</signature>
      <path>Managed by ExternalSecrets Operator</path>
    </interface>
    <interface>
      <name>AWS CloudTrail API</name>
      <kind>REST API (audit logging)</kind>
      <signature>secretsmanager:GetSecretValue events logged</signature>
      <path>AWS CloudTrail console and S3 bucket</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Infrastructure testing follows acceptance test verification pattern using AWS CLI, kubectl, and application tests. Each AC has explicit verification. DevOps Lead executes verification. Integration test validates secret retrieval from K8s pod and rotation process.
    </standards>
    <locations>
      <location>Manual verification via AWS Console, CLI, and kubectl</location>
      <location>Terraform plan/apply output validation</location>
      <location>kubectl commands for ExternalSecrets verification</location>
      <location>CloudTrail logs for audit verification</location>
    </locations>
    <ideas>
      <idea ac="1">aws secretsmanager list-secrets returns list including qualisys/* secrets</idea>
      <idea ac="2">aws secretsmanager get-secret-value --secret-id qualisys/database/connection returns JSON with host, port, etc.</idea>
      <idea ac="3">aws secretsmanager get-secret-value --secret-id qualisys/redis/connection returns JSON with endpoints</idea>
      <idea ac="4">aws secretsmanager get-secret-value --secret-id qualisys/jwt/signing-key returns 32+ char secret</idea>
      <idea ac="5">aws secretsmanager get-secret-value for qualisys/llm/openai and qualisys/llm/anthropic succeed</idea>
      <idea ac="6">aws secretsmanager get-secret-value --secret-id qualisys/oauth/google returns client_id and client_secret</idea>
      <idea ac="7">aws secretsmanager get-secret-value --secret-id qualisys/email/sendgrid returns api_key</idea>
      <idea ac="8">kubectl get pods -n external-secrets shows external-secrets operator running</idea>
      <idea ac="9">kubectl get externalsecrets -A shows all ExternalSecrets with SecretSynced=True status</idea>
      <idea ac="10">aws secretsmanager describe-secret --secret-id qualisys/database/connection shows RotationEnabled=true</idea>
      <idea ac="11">aws cloudtrail lookup-events --lookup-attributes AttributeKey=EventName,AttributeValue=GetSecretValue returns events</idea>
      <idea ac="12">Attempt secret access with unauthorized role, verify AccessDenied error</idea>
      <idea ac="sync">Update secret in Secrets Manager, verify K8s secret updated within refreshInterval</idea>
      <idea ac="rotation">Trigger manual rotation, verify new password works, old password fails</idea>
      <idea ac="irsa">kubectl exec into pod, verify AWS_WEB_IDENTITY_TOKEN_FILE exists (IRSA working)</idea>
      <idea ac="alarm">Simulate unauthorized access, verify CloudWatch alarm triggered</idea>
    </ideas>
  </tests>
</story-context>
