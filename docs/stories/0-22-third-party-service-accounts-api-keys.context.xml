<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>22</storyId>
    <title>Third-Party Service Accounts and API Keys</title>
    <status>drafted</status>
    <generatedAt>2026-01-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/0-22-third-party-service-accounts-api-keys.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>DevOps Engineer</asA>
    <iWant>to provision all third-party service accounts and API keys</iWant>
    <soThat>Epic 2-5 integrations can be implemented without delays</soThat>
    <tasks>
      <task id="1" name="LLM Provider Accounts" acs="1,2,10">
        <subtask>1.1 Create OpenAI organization account</subtask>
        <subtask>1.2 Generate OpenAI API key with usage limits</subtask>
        <subtask>1.3 Configure OpenAI billing alerts ($50, $100, $200)</subtask>
        <subtask>1.4 Store OpenAI API key in Secrets Manager</subtask>
        <subtask>1.5 Create Anthropic account</subtask>
        <subtask>1.6 Generate Anthropic API key</subtask>
        <subtask>1.7 Configure Anthropic billing alerts</subtask>
        <subtask>1.8 Store Anthropic API key in Secrets Manager</subtask>
      </task>
      <task id="2" name="Authentication Provider" acs="3">
        <subtask>2.1 Create Google Cloud project for OAuth</subtask>
        <subtask>2.2 Configure OAuth consent screen</subtask>
        <subtask>2.3 Create OAuth 2.0 client credentials</subtask>
        <subtask>2.4 Add authorized redirect URIs</subtask>
        <subtask>2.5 Store client ID and secret in Secrets Manager</subtask>
      </task>
      <task id="3" name="Email Service" acs="4">
        <subtask>3.1 Create SendGrid account (or Postmark)</subtask>
        <subtask>3.2 Verify sender domain</subtask>
        <subtask>3.3 Generate API key with appropriate permissions</subtask>
        <subtask>3.4 Configure email templates (optional)</subtask>
        <subtask>3.5 Store API key in Secrets Manager</subtask>
      </task>
      <task id="4" name="Integration Services" acs="5,6,7">
        <subtask>4.1 Create Jira integration credentials (defer if not ready)</subtask>
        <subtask>4.2 Create Slack App and webhook URL</subtask>
        <subtask>4.3 Create GitHub App for repository integration</subtask>
        <subtask>4.4 Store all credentials in Secrets Manager</subtask>
      </task>
      <task id="5" name="Documentation and Security" acs="8,9,11">
        <subtask>5.1 Document all secrets with purpose in Secrets Manager</subtask>
        <subtask>5.2 Add expiration tags to secrets</subtask>
        <subtask>5.3 Create API key rotation schedule</subtask>
        <subtask>5.4 Document rate limits and quotas</subtask>
        <subtask>5.5 Create credentials inventory spreadsheet</subtask>
      </task>
      <task id="6" name="Kubernetes Integration" acs="12">
        <subtask>6.1 Configure ExternalSecrets Operator (if not already)</subtask>
        <subtask>6.2 Create ExternalSecret resources for each secret</subtask>
        <subtask>6.3 Verify secrets sync to Kubernetes namespaces</subtask>
        <subtask>6.4 Document secret access patterns</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">OpenAI API account created, API key generated and stored in secret manager</criterion>
    <criterion id="AC2">Anthropic API account created, API key generated and stored</criterion>
    <criterion id="AC3">Google OAuth client ID/secret created for SSO (Epic 1)</criterion>
    <criterion id="AC4">SendGrid or Postmark account created for transactional emails (Epic 1)</criterion>
    <criterion id="AC5">Jira integration account created (Epic 5, can defer)</criterion>
    <criterion id="AC6">Slack webhook configured for notifications (Epic 5, can defer)</criterion>
    <criterion id="AC7">GitHub App created for repository integration (Epic 3, can defer)</criterion>
    <criterion id="AC8">All API keys documented in secret manager with purpose and expiration</criterion>
    <criterion id="AC9">API key rotation schedule defined (quarterly for LLM keys)</criterion>
    <criterion id="AC10">Billing alerts configured for LLM APIs</criterion>
    <criterion id="AC11">Rate limits and quotas documented</criterion>
    <criterion id="AC12">ExternalSecrets configuration for Kubernetes access</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-specs/tech-spec-epic-0.md</path>
        <title>Epic 0 Technical Specification</title>
        <section>Third-Party Dependencies</section>
        <snippet>OpenAI/Anthropic for AI agents, Google OAuth for SSO, SendGrid for email, GitHub App for integration.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-0-infrastructure.md</path>
        <title>Epic 0: Infrastructure Foundation</title>
        <section>Story 0.22: Third-Party API Keys</section>
        <snippet>Provision all third-party service accounts and API keys for Epic 2-5 integrations.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Integration Architecture</section>
        <snippet>LLM providers (OpenAI, Anthropic), authentication (Google OAuth), email (SendGrid), integrations (GitHub, Jira, Slack).</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>docs/stories/0-7-secret-management.md</path>
        <kind>story</kind>
        <symbol>Secret Management</symbol>
        <reason>Dependency: Secrets Manager infrastructure for storing API keys</reason>
      </file>
      <file>
        <path>docs/stories/0-1-cloud-account-iam-setup.md</path>
        <kind>story</kind>
        <symbol>IAM Setup</symbol>
        <reason>Dependency: IAM roles for secret access</reason>
      </file>
    </code>
    <dependencies>
      <terraform>
        <resource name="aws_secretsmanager_secret">Secret storage for API keys</resource>
        <resource name="aws_secretsmanager_secret_version">Secret values</resource>
      </terraform>
      <kubernetes>
        <crd name="external-secrets.io/v1beta1/ExternalSecret">Sync secrets to K8s</crd>
        <crd name="external-secrets.io/v1beta1/SecretStore">Connect to Secrets Manager</crd>
      </kubernetes>
      <services>
        <service name="OpenAI" url="https://platform.openai.com">LLM API provider</service>
        <service name="Anthropic" url="https://console.anthropic.com">Claude API provider</service>
        <service name="Google Cloud" url="https://console.cloud.google.com">OAuth provider</service>
        <service name="SendGrid" url="https://sendgrid.com">Email service</service>
        <service name="GitHub" url="https://github.com/settings/apps">GitHub App</service>
        <service name="Slack" url="https://api.slack.com/apps">Slack App</service>
        <service name="Jira" url="https://developer.atlassian.com">Jira API</service>
      </services>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="storage">AWS Secrets Manager (not environment variables)</constraint>
    <constraint type="account">Organizational accounts (not personal)</constraint>
    <constraint type="billing">Alerts configured to prevent runaway LLM costs</constraint>
    <constraint type="rotation">Quarterly rotation for LLM API keys</constraint>
    <constraint type="deferrable">Jira, Slack, GitHub App can be deferred to later epics</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>OpenAI API</name>
      <kind>REST API</kind>
      <signature>Authorization: Bearer sk-...</signature>
      <path>/qualisys/{env}/llm/openai-api-key</path>
    </interface>
    <interface>
      <name>Anthropic API</name>
      <kind>REST API</kind>
      <signature>x-api-key: sk-ant-...</signature>
      <path>/qualisys/{env}/llm/anthropic-api-key</path>
    </interface>
    <interface>
      <name>Google OAuth</name>
      <kind>OAuth 2.0</kind>
      <signature>client_id, client_secret</signature>
      <path>/qualisys/{env}/auth/google-oauth</path>
    </interface>
    <interface>
      <name>SendGrid API</name>
      <kind>REST API</kind>
      <signature>Authorization: Bearer SG...</signature>
      <path>/qualisys/{env}/email/sendgrid-api-key</path>
    </interface>
    <interface>
      <name>ExternalSecret</name>
      <kind>Kubernetes CRD</kind>
      <signature>external-secrets.io/v1beta1 ExternalSecret</signature>
      <path>k8s/secrets/external-secrets.yaml</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Manual validation of third-party accounts and API keys. Verify secrets exist in Secrets Manager,
      billing alerts configured, and ExternalSecrets sync to Kubernetes. Document rate limits.
    </standards>
    <locations>
      <location>terraform/modules/secrets/</location>
      <location>k8s/secrets/</location>
      <location>docs/secrets/</location>
    </locations>
    <ideas>
      <idea ac="AC1">Verify OpenAI API key in Secrets Manager, test API call</idea>
      <idea ac="AC2">Verify Anthropic API key in Secrets Manager, test API call</idea>
      <idea ac="AC3">Verify Google OAuth flow works with test redirect</idea>
      <idea ac="AC4">Verify SendGrid can send test email</idea>
      <idea ac="AC5">Document Jira integration (defer if needed)</idea>
      <idea ac="AC6">Verify Slack webhook posts test message</idea>
      <idea ac="AC7">Verify GitHub App can access test repository</idea>
      <idea ac="AC8">Review Secrets Manager tags for purpose/expiration</idea>
      <idea ac="AC9">Review rotation schedule documentation</idea>
      <idea ac="AC10">Verify billing alerts in OpenAI/Anthropic dashboards</idea>
      <idea ac="AC11">Review rate limits documentation</idea>
      <idea ac="AC12">Verify ExternalSecret syncs to K8s namespace</idea>
    </ideas>
  </tests>
</story-context>
