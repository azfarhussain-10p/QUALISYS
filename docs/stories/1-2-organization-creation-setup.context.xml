<story-context id="bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>2</storyId>
    <title>Organization Creation &amp; Setup</title>
    <status>drafted</status>
    <generatedAt>2026-02-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-2-organization-creation-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Owner</asA>
    <iWant>create my organization and configure settings</iWant>
    <soThat>my team can collaborate on the QUALISYS platform</soThat>
    <tasks>
      <task id="1" title="Database Schema — Tenants &amp; Membership" acs="2,4">
        <subtask>1.1 Alembic migration for public.tenants table (UUID PK, name, slug unique, logo_url, custom_domain, data_retention_days default 365, plan default 'free', settings JSONB, created_by FK, timestamps)</subtask>
        <subtask>1.2 Create unique index on LOWER(slug) for case-insensitive uniqueness</subtask>
        <subtask>1.3 Alembic migration for public.tenants_users join table (tenant_id FK, user_id FK, role varchar 30, joined_at timestamptz, PK on tenant_id + user_id)</subtask>
        <subtask>1.4 Add default_tenant_id column (UUID FK nullable) to public.users via migration</subtask>
        <subtask>1.5 Create SQLAlchemy models: Tenant, TenantUser</subtask>
        <subtask>1.6 Write migration rollback scripts</subtask>
      </task>
      <task id="2" title="Tenant Schema Provisioning Service" acs="3">
        <subtask>2.1 Create TenantProvisioningService that creates PostgreSQL schema tenant_{slug}</subtask>
        <subtask>2.2 Implement base migration runner for new tenant schemas (creates org_members, audit_logs tables)</subtask>
        <subtask>2.3 Wrap schema creation + migration in transaction with rollback on failure</subtask>
        <subtask>2.4 Implement async provisioning with status tracking (pending/provisioning/ready/failed)</subtask>
        <subtask>2.5 Validate schema name against SQL injection: allow only [a-z0-9_] pattern</subtask>
      </task>
      <task id="3" title="Tenant Context Middleware" acs="8">
        <subtask>3.1 Create FastAPI middleware that extracts default_tenant_id from authenticated user JWT</subtask>
        <subtask>3.2 Set PostgreSQL search_path to tenant_{slug} for current request using ContextVar</subtask>
        <subtask>3.3 Validate tenant exists in public.tenants and user has membership in public.tenants_users</subtask>
        <subtask>3.4 Return 403 if user has no membership in the requested tenant</subtask>
        <subtask>3.5 Ensure ContextVar is immutable per request (prevent tenant context switching mid-request)</subtask>
      </task>
      <task id="4" title="FastAPI Organization Endpoints" acs="1,2,4,5,7,9">
        <subtask>4.1 POST /api/v1/orgs — create organization (name, slug, logo_url, custom_domain)</subtask>
        <subtask>4.2 Slug auto-generation from name (slugify + collision detection with incrementing suffix)</subtask>
        <subtask>4.3 Owner/Admin role assignment in tenants_users + update users.default_tenant_id</subtask>
        <subtask>4.4 Trigger async tenant schema provisioning after org record created</subtask>
        <subtask>4.5 GET /api/v1/orgs/{org_id}/settings (Owner/Admin only)</subtask>
        <subtask>4.6 PATCH /api/v1/orgs/{org_id}/settings (Owner/Admin only, slug uniqueness check)</subtask>
        <subtask>4.7 Rate limit org creation: 3 per user per hour (Redis-backed)</subtask>
        <subtask>4.8 Audit log all org creation and settings changes</subtask>
      </task>
      <task id="5" title="Logo Upload" acs="6">
        <subtask>5.1 POST /api/v1/orgs/{org_id}/logo/presigned-url — generates S3 pre-signed upload URL</subtask>
        <subtask>5.2 Validate file type (PNG, JPG, SVG) and size (max 2MB)</subtask>
        <subtask>5.3 S3 bucket path: tenants/{tenant_id}/logo/{filename}</subtask>
        <subtask>5.4 Server-side image resize to 256x256 thumbnail (Pillow or Lambda trigger)</subtask>
        <subtask>5.5 Update tenants.logo_url after upload confirmation</subtask>
      </task>
      <task id="6" title="React Organization UI" acs="1,5,6">
        <subtask>6.1 /create-org route with org creation form (name, slug preview, logo upload, custom domain)</subtask>
        <subtask>6.2 Slug auto-preview (debounced, availability check)</subtask>
        <subtask>6.3 Logo drag-and-drop upload with preview and crop</subtask>
        <subtask>6.4 "Setting up your organization..." progress page with async status polling</subtask>
        <subtask>6.5 /settings/organization page for Owner/Admin</subtask>
        <subtask>6.6 Data retention policy dropdown (30/90/180/365 days)</subtask>
        <subtask>6.7 First-time user detection: redirect to /create-org if no org membership</subtask>
      </task>
      <task id="7" title="Testing" acs="all">
        <subtask>7.1 Unit tests: slug generation, validation, schema name sanitization, tenant context middleware</subtask>
        <subtask>7.2 Integration: POST /api/v1/orgs (happy path, duplicate slug, rate limit, invalid input)</subtask>
        <subtask>7.3 Integration: tenant schema provisioning (schema created, migration applied, rollback on failure)</subtask>
        <subtask>7.4 Integration: tenant context middleware (correct search_path, 403 on no membership, immutable context)</subtask>
        <subtask>7.5 Integration: org settings CRUD (Owner access, non-Owner denied, slug change validation)</subtask>
        <subtask>7.6 Integration: logo upload (pre-signed URL, file type validation, size limit)</subtask>
        <subtask>7.7 Security: SQL injection in slug/schema rejected, cross-tenant access denied, RBAC enforced</subtask>
        <subtask>7.8 Frontend: create-org form, slug preview, logo upload, settings page</subtask>
      </task>
      <task id="8" title="Security Review" acs="9">
        <subtask>8.1 Verify tenant schema name uses parameterized DDL (no string interpolation)</subtask>
        <subtask>8.2 Verify ContextVar prevents tenant context switching mid-request</subtask>
        <subtask>8.3 Verify RBAC check on all settings endpoints (Owner/Admin only)</subtask>
        <subtask>8.4 Verify audit logging captures all org creation and modification events</subtask>
        <subtask>8.5 Verify S3 bucket policy restricts access to tenant-scoped paths only</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1" title="First-Time User Onboarding Prompt">After signup, first-time users redirected to Create Organization page. Form: name (3-100 chars), slug (auto-generated, editable, URL-safe, unique), logo upload (optional, max 2MB, PNG/JPG/SVG), custom domain (optional). Skip option for invited users.</ac>
    <ac id="2" title="Organization Database Record">Record in public.tenants with UUID, name, slug (unique lowercase), logo_url, custom_domain, data_retention_days (default 365), plan (default 'free'), settings JSONB, created_by FK, timestamps. Slug validated: lowercase alphanumeric + hyphens, no leading/trailing hyphens.</ac>
    <ac id="3" title="Tenant Schema Provisioning">Creates PostgreSQL schema tenant_{slug}. Base migration tables (org_members, audit_logs). Transaction-wrapped with rollback on failure. Async with progress indicator.</ac>
    <ac id="4" title="Owner/Admin Role Assignment">Creating user assigned owner role in public.tenants_users. User's default_tenant_id set. Redirect to org dashboard with Owner permissions.</ac>
    <ac id="5" title="Organization Settings Page">Owner/Admin only (RBAC enforced). Edit: name, slug (uniqueness re-check), logo, custom domain, data retention dropdown (30/90/180/365 days). PATCH /api/v1/orgs/{org_id}/settings.</ac>
    <ac id="6" title="Logo Upload">S3 bucket: tenants/{tenant_id}/logo/{filename}. PNG/JPG/SVG, max 2MB. Server-side resize to 256x256 thumbnail. Pre-signed URL for direct browser-to-S3 upload.</ac>
    <ac id="7" title="Duplicate Organization Prevention">Reject if slug exists (case-insensitive). Auto-append incrementing number on collision. Error message guidance.</ac>
    <ac id="8" title="Tenant Context Middleware">FastAPI middleware extracts tenant from JWT default_tenant_id. Sets PostgreSQL search_path. ContextVar (immutable per request). Validates tenant exists and user has membership.</ac>
    <ac id="9" title="Security and Audit">Org creation logged in audit trail. Schema name validated against SQL injection. Parameterized DDL. Rate limit: 3 org creations per user per hour.</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/planning/prd.md" title="Product Requirements Document v3.0" section="User Account &amp; Access Management" snippet="FR2: Users can create organizations and become the first Owner/Admin. FR102: Admins can configure organization-wide settings. FR105: Data retention policies." />
      <doc path="docs/planning/prd.md" title="PRD" section="Multi-Tenancy Architecture" snippet="Schema-level PostgreSQL isolation. Tenant onboarding: first user creates org and becomes Owner/Admin. Schema provisioning on org creation." />
      <doc path="docs/planning/prd.md" title="PRD" section="Data Privacy" snippet="Data retention policies configurable per tenant: 30/90/180/365 days. GDPR compliance consideration." />
      <doc path="docs/tech-specs/tech-spec-epic-1.md" title="Tech Spec — Epic 1" section="Multi-Tenancy Architecture" snippet="PostgreSQL schema isolation. public.tenants registry, public.users cross-tenant lookup. Defense-in-depth: schema isolation, RLS, application-level validation, daily audit." />
      <doc path="docs/tech-specs/tech-spec-epic-1.md" title="Tech Spec — Epic 1" section="RBAC Permission Matrix" snippet="6 roles. Owner/Admin: create projects, invite users, manage billing, configure integrations. All roles: view dashboards." />
      <doc path="docs/tech-specs/tech-spec-epic-1.md" title="Tech Spec — Epic 1" section="Authentication Architecture" snippet="JWT tokens (7-day expiry, httpOnly cookies). Redis session storage. Tenant context extracted from JWT." />
      <doc path="docs/architecture/architecture.md" title="System Architecture" section="ADR-001" snippet="Schema-per-tenant strategy. Alembic per-tenant migrations. ContextVar-based DB connection routing. Schema naming: tenant_{slug}." />
      <doc path="docs/architecture/architecture.md" title="System Architecture" section="Four-Pillar Multi-Tenancy" snippet="Data isolation (schema-level), performance isolation (connection pooling), cost isolation (metering), failure isolation (circuit breakers)." />
      <doc path="docs/architecture/architecture.md" title="System Architecture" section="Security Threat Model" snippet="RLS race condition prevention via ContextVar. Cross-tenant audit scanning. SQL injection prevention via parameterized queries." />
      <doc path="docs/architecture/architecture.md" title="System Architecture" section="Technology Stack" snippet="Backend: Python 3.11+ / FastAPI. Frontend: Vite + React 18, Tailwind + shadcn/ui. Object storage: AWS S3." />
      <doc path="docs/epics/epics.md" title="Epic &amp; Story Breakdown" section="Story 1.2" snippet="As Owner, create org and configure settings. 4 ACs: onboarding, schema creation, owner role, settings page. FRs: FR2, FR102, FR105." />
      <doc path="docs/stories/1-1-user-account-creation.md" title="Story 1.1" section="Architecture Patterns" snippet="User records in public.users. Auth provider enum. bcrypt password hashing. Rate limiting with Redis. Email service via SendGrid/SES. Project structure conventions established." />
      <doc path="docs/planning/ux-design-specification.md" title="UX Design" section="Organization Setup" snippet="Organization creation wizard, logo upload, slug preview, settings page with data retention controls." />
    </docs>

    <code>
      <file path="backend/tests/conftest.py" kind="test-config" symbol="test_engine, db_session, client, existing_user, make_user_payload" reason="Pytest fixtures from Story 1.1: session-scoped engine (SQLite in-memory or TEST_DATABASE_URL), per-test transaction-rollback db_session, AsyncClient with get_db override, existing_user factory. Story 1.2 must ADD test_tenant fixture here for tenant schema isolation." />
      <file path="scripts/init-local-db.sql" kind="seed" symbol="tenant_dev_1, tenant_dev_2" reason="Local dev DB init — creates dev tenant schemas with base tables. Reference for tenant schema structure and naming convention (tenant_{name})." />
      <file path="compose.yml" kind="config" symbol="podman-compose" reason="Local dev environment with PostgreSQL 15, Redis 7 services. Use for local org creation testing." />
      <file path=".github/workflows/pr-checks.yml" kind="ci" symbol="pr-checks" reason="CI pipeline — new tests run automatically" />
      <file path="backend/src/models/user.py" kind="model" symbol="User" reason="Story 1.1 User model (existing) — org creation adds default_tenant_id FK column via Alembic migration" />
      <file path="backend/src/api/v1/auth/router.py" kind="api" symbol="register, google_callback, verify_email_endpoint" reason="Story 1.1 auth endpoints (existing) — org creation redirects post-signup users to /create-org" />
      <file path="backend/src/services/notification/notification_service.py" kind="service" symbol="send_verification_email" reason="Story 1.1 email service (existing) — reuse infrastructure for org-related notification emails" />
    </code>

    <dependencies>
      <ecosystem name="python">
        <note>Backend stack (Python 3.11+ / FastAPI — backend/pyproject.toml exists, created Story 1.1)</note>
        <package name="fastapi" version="latest" reason="API framework — org endpoints" />
        <package name="sqlalchemy" version="2.x" reason="ORM — Tenant, TenantUser models, schema routing" />
        <package name="alembic" version="latest" reason="Database migrations — tenants table, tenants_users, per-tenant schemas" />
        <package name="pydantic" version="2.x" reason="Request/response validation for org endpoints" />
        <package name="redis" version="latest" reason="Rate limiting org creation (3/user/hr)" />
        <package name="boto3" version="latest" reason="AWS S3 pre-signed URL generation for logo upload" />
        <package name="pillow" version="latest" reason="Server-side image resize to 256x256 thumbnail" />
        <package name="python-slugify" version="latest" reason="Slug generation from org name" />
        <package name="asyncpg" version="latest" reason="Async PostgreSQL — schema creation DDL (existing in conftest.py)" />
      </ecosystem>
      <ecosystem name="node">
        <note>Frontend stack (planned from architecture)</note>
        <package name="react" version="18.x" reason="UI framework" />
        <package name="vite" version="latest" reason="Build tool" />
        <package name="tailwindcss" version="3.x" reason="Styling" />
        <package name="@shadcn/ui" version="latest" reason="UI components (Form, Input, Select, Dialog, Card)" />
        <package name="react-dropzone" version="latest" reason="Logo drag-and-drop upload" />
        <package name="vitest" version="latest" reason="Test runner (Vite-native, replaces Jest)" />
        <package name="@testing-library/react" version="latest" reason="Component tests" />
      </ecosystem>
      <ecosystem name="infrastructure">
        <package name="postgresql" version="15+" reason="Multi-tenant database — schema-per-tenant" />
        <package name="redis" version="7+" reason="Rate limiting, session storage" />
        <package name="aws-s3" version="API" reason="Logo storage with pre-signed URLs" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="architecture" priority="critical">Multi-tenancy: Schema-per-tenant PostgreSQL isolation (ADR-001). Schema naming convention: tenant_{slug}. public.tenants for registry, public.tenants_users for membership. ContextVar-based routing.</constraint>
    <constraint source="architecture" priority="critical">SQL injection prevention: Schema name validated with [a-z0-9_] pattern ONLY (re.fullmatch). All DDL uses psycopg2.sql.Identifier or equivalent parameterized DDL — no raw string interpolation. Implement validate_safe_identifier() in TenantProvisioningService and test with injection payloads ('; DROP TABLE, etc.).</constraint>
    <constraint source="architecture" priority="critical">Defense-in-depth: Schema isolation (primary) + RLS policies (defense layer) + application-level tenant context validation. Story 1.2 must add RLS_POLICY_DDL constant and test_tenant fixture to backend/tests/conftest.py.</constraint>
    <constraint source="architecture" priority="high">ContextVar immutability: Tenant context set once per request in middleware, immutable afterward. Prevents RLS race condition identified in architecture threat model.</constraint>
    <constraint source="architecture" priority="high">S3 bucket policy: Restrict access to tenant-scoped paths (tenants/{tenant_id}/logo/). Pre-signed URLs for direct browser upload (no backend proxy).</constraint>
    <constraint source="prd" priority="high">Data retention: Configurable per tenant (30/90/180/365 days, default 365). Stored in tenants table settings.</constraint>
    <constraint source="architecture" priority="high">RBAC: Only Owner/Admin can access org settings endpoints. Use @require_role decorator pattern. 6 roles: Owner/Admin, PM/CSM, QA-Manual, QA-Automation, Dev, Viewer.</constraint>
    <constraint source="architecture" priority="medium">Slug rules: URL-safe (lowercase alphanumeric + hyphens), no leading/trailing hyphens, max 50 chars (PostgreSQL 63-char identifier limit minus "tenant_" prefix). Auto-generated from name, collision detection with incrementing suffix.</constraint>
    <constraint source="architecture" priority="medium">Async schema provisioning: User sees progress indicator. Status: pending → provisioning → ready → failed. If failed, org record remains with retry option.</constraint>
    <constraint source="dev-notes" priority="medium">Audit logging: All org creation and settings modification events logged with actor, action, timestamp, tenant_id.</constraint>
  </constraints>

  <interfaces>
    <interface name="POST /api/v1/orgs" kind="REST endpoint" signature="POST /api/v1/orgs — Body: { name: string, slug?: string, logo_url?: string, custom_domain?: string } — Returns: { data: { id, name, slug, status } } — Auth: Authenticated user" path="backend/src/api/v1/orgs/" />
    <interface name="GET /api/v1/orgs/{org_id}/settings" kind="REST endpoint" signature="GET /api/v1/orgs/{org_id}/settings — Returns: { data: { name, slug, logo_url, custom_domain, data_retention_days, plan, settings } } — Auth: Owner/Admin only" path="backend/src/api/v1/orgs/" />
    <interface name="PATCH /api/v1/orgs/{org_id}/settings" kind="REST endpoint" signature="PATCH /api/v1/orgs/{org_id}/settings — Body: partial update fields — Returns: { data: updated_settings } — Auth: Owner/Admin only" path="backend/src/api/v1/orgs/" />
    <interface name="POST /api/v1/orgs/{org_id}/logo/presigned-url" kind="REST endpoint" signature="POST — Body: { filename, content_type } — Returns: { upload_url, fields } — Auth: Owner/Admin only" path="backend/src/api/v1/orgs/" />
    <interface name="TenantProvisioningService" kind="service class" signature="class TenantProvisioningService: provision_tenant(slug) -> status; get_provisioning_status(tenant_id) -> ProvisioningStatus; rollback_provisioning(tenant_id) -> None" path="backend/src/services/tenant_provisioning.py" />
    <interface name="TenantContextMiddleware" kind="middleware" signature="FastAPI middleware: extracts default_tenant_id from JWT, resolves slug, sets search_path to tenant_{slug} via ContextVar. Returns 403 if no membership." path="backend/src/middleware/tenant_context.py" />
    <interface name="@require_role" kind="decorator" signature="@require_role('owner') — FastAPI dependency that validates current user has specified role in current tenant. Returns 403 if not." path="backend/src/middleware/rbac.py" />
    <interface name="Tenant model" kind="SQLAlchemy model" signature="class Tenant(Base): id: UUID, name: str, slug: str unique, logo_url: str?, custom_domain: str?, data_retention_days: int(365), plan: str('free'), settings: JSONB, created_by: UUID FK, created_at, updated_at" path="backend/src/models/tenant.py" />
    <interface name="TenantUser model" kind="SQLAlchemy model" signature="class TenantUser(Base): tenant_id: UUID FK, user_id: UUID FK, role: str, joined_at: datetime — PK: (tenant_id, user_id)" path="backend/src/models/tenant.py" />
    <interface name="test_tenant fixture" kind="pytest fixture" signature="@pytest_asyncio.fixture async def test_tenant(db_session) -> AsyncGenerator[dict, None] — Creates isolated test schema with RLS policies, yields {tenant_id, schema_name}, drops schema on cleanup. MUST BE CREATED in Story 1.2 (not yet in conftest.py)" path="backend/tests/conftest.py" />
  </interfaces>

  <tests>
    <standards>Backend: Pytest with async test client (httpx), PostgreSQL test database with per-test transaction rollback (asyncio_mode=auto via backend/pyproject.toml). Story 1.1 conftest.py provides test_engine, db_session, client, existing_user fixtures. Story 1.2 must ADD test_tenant fixture (creates/drops tenant schema with RLS per test). Frontend: Vitest + React Testing Library. Coverage target: 80%+ for new code. Tenant provisioning tests need dedicated test schemas (cleaned up after each test run). Security tests for cross-tenant access are critical per architecture threat model. Implement Python validate_safe_identifier() in TenantProvisioningService and test with SQL injection payloads.</standards>
    <locations>
      <location>backend/tests/conftest.py — Pytest fixtures: test_engine, db_session, client, existing_user (Story 1.1); test_tenant, RLS_POLICY_DDL to be added (Story 1.2)</location>
      <location>backend/tests/unit/ — Unit tests for slug generation, schema validation, ContextVar middleware</location>
      <location>backend/tests/integration/ — API endpoint tests with DB (org CRUD, provisioning, settings)</location>
      <location>backend/tests/security/ — SQL injection, cross-tenant access, RBAC enforcement</location>
      <location>web/src/pages/**/__tests__/ — Frontend Vitest component tests (org creation wizard, settings page)</location>
    </locations>
    <ideas>
      <idea ac="1">Test first-time user redirect to /create-org. Test form validation (name length, slug format). Test skip option renders for invited users. Test slug auto-generation preview (debounced).</idea>
      <idea ac="2">Test org record created with correct fields (UUID, name, slug, defaults). Test LOWER(slug) unique index prevents case-insensitive duplicates. Test JSONB settings default. Test created_by FK populated.</idea>
      <idea ac="3">Test schema created (query pg_catalog.pg_namespace). Test base tables exist in new schema. Test transaction rollback on migration failure (mock failure). Test async provisioning status transitions. Test schema name uses [a-z0-9_] only.</idea>
      <idea ac="4">Test owner role assigned in tenants_users. Test default_tenant_id updated in users table. Test redirect to org dashboard after creation.</idea>
      <idea ac="5">Test Owner can GET settings. Test Owner can PATCH settings. Test non-Owner gets 403. Test slug change triggers uniqueness re-check. Test data retention dropdown values.</idea>
      <idea ac="6">Test pre-signed URL generation. Test file type validation (reject .exe, accept PNG/JPG/SVG). Test 2MB size limit. Test logo_url updated after upload. Test thumbnail generated at 256x256.</idea>
      <idea ac="7">Test duplicate slug rejected with error message. Test auto-increment suffix (my-org, my-org-1, my-org-2). Test case-insensitive collision detection.</idea>
      <idea ac="8">Test middleware sets correct search_path. Test ContextVar immutable per request. Test 403 on no membership. Test middleware skips public endpoints. Test concurrent requests get isolated contexts.</idea>
      <idea ac="9">Test audit log entries for org creation and settings changes. Test schema name rejects SQL injection payloads (['; DROP TABLE]). Test rate limit 3 org creations per user per hour. Test parameterized DDL (no string interpolation).</idea>
    </ideas>
  </tests>
</story-context>
