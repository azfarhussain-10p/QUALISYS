<story-context id="1-6-password-reset-flow" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>6</storyId>
    <title>Password Reset Flow</title>
    <status>ready-for-dev</status>
    <generatedAt>2026-02-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-6-password-reset-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user who forgot their password</asA>
    <iWant>reset it via email verification</iWant>
    <soThat>I can regain access to my account</soThat>
    <tasks>
      <task id="1" title="Database Schema — Password Resets" acs="3">Alembic migration for public.password_resets table (id, user_id FK, token_hash, expires_at, used_at, created_at); indexes on token_hash and (user_id, used_at)</task>
      <task id="2" title="Password Reset Service" acs="3,6">PasswordResetService: request_reset(), validate_token(), reset_password(), invalidate_previous_tokens(). Token generation, SHA-256 hash storage, Google-only account handling</task>
      <task id="3" title="FastAPI Endpoints" acs="2,5,6,7">POST forgot-password (no enumeration), GET reset-password?token (validate), POST reset-password (update password + invalidate sessions); rate limiting, audit</task>
      <task id="4" title="Reset Email Template" acs="4">Branded HTML template with CTA button, Google-only variant, async delivery via existing email service, retry logic</task>
      <task id="5" title="React UI — Forgot Password" acs="1,2">Forgot Password link on login page, /forgot-password page with email form, always-success message, rate limit handling</task>
      <task id="6" title="React UI — Reset Password" acs="5,6">Token validation on load, new password + confirm form, strength indicator (reuse from Story 1.1), error states, redirect to login on success</task>
      <task id="7" title="Testing" acs="all">Unit, integration (forgot-password, validate token, reset password, session invalidation, token invalidation, rate limiting), security (no enumeration, timing, entropy), frontend tests</task>
      <task id="8" title="Security Review" acs="3,7,8">Token entropy, hash storage, no enumeration (response + timing), single-use tokens, session invalidation, password reuse check, rate limiting bypass</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1" title="Forgot Password Link">Login page includes 'Forgot Password?' link navigating to /forgot-password</ac>
    <ac id="2" title="Reset Request Form">/forgot-password page with email input, always returns success message regardless of email existence (no enumeration)</ac>
    <ac id="3" title="Reset Token Generation">Cryptographic token (secrets.token_urlsafe(32)), SHA-256 hash stored in public.password_resets, 1-hour expiry, previous tokens invalidated. Google-only accounts get alternative email</ac>
    <ac id="4" title="Reset Email Delivery">Branded HTML email via SendGrid/SES with CTA button, expiry notice, security notice. Async with 3-attempt retry</ac>
    <ac id="5" title="Reset Password Page">/reset-password?token validates on load, new password + confirm form with strength indicator, error page for invalid/expired/used tokens</ac>
    <ac id="6" title="Password Update">Validates token + password policy + not-same-as-old, updates bcrypt hash, marks token used, invalidates ALL sessions (AuthService.logout_all), redirects to login</ac>
    <ac id="7" title="Rate Limiting &amp; Abuse Prevention">3 req/email/hour on forgot-password, 5 attempts/token/hour on reset, 10 attempts/IP/hour global. 429 with Retry-After</ac>
    <ac id="8" title="Audit Trail">All actions logged: reset requested, email sent, reset completed, reset failed — with IP, user_agent, timestamp</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/planning/prd.md" title="Product Requirements Document v3.0" section="User Account &amp; Access Management" snippet="FR4: Users can reset passwords via email verification workflow." />
      <doc path="docs/planning/prd.md" title="PRD v3.0" section="NFR-SEC1: Authentication &amp; Authorization" snippet="Password requirements: Min 12 characters, uppercase, lowercase, number, special character. Session tokens: JWT with 7-day expiry, secure httpOnly cookies." />
      <doc path="docs/tech-specs/tech-spec-epic-1.md" title="Tech Spec — Epic 1" section="Authentication Flow" snippet="Mermaid diagram: User → Email/Password or Google SSO → Validate → MFA Check → JWT → Session (Redis) → Tenant Context." />
      <doc path="docs/tech-specs/tech-spec-epic-1.md" title="Tech Spec — Epic 1" section="Session Management" snippet="JWT tokens (7-day expiry, httpOnly cookies), refresh token rotation, Redis for session storage and rate limiting." />
      <doc path="docs/architecture/architecture.md" title="System Architecture" section="Third-Party Services" snippet="SendGrid or AWS SES for transactional emails. Redis 7+ for caching, sessions, rate limiting." />
      <doc path="docs/architecture/architecture.md" title="System Architecture" section="Security Threat Model" snippet="RBAC enforcement, audit trails, rate limiting on auth endpoints, token security." />
      <doc path="docs/epics/epics.md" title="Epics &amp; Stories" section="Story 1.6" snippet="AC1: Forgot Password link. AC2: Email with reset link (1 hour expiry). AC3: Reset page with strength validation. AC4: Password updated, redirect to login. FRs: FR4." />
      <doc path="docs/stories/1-1-user-account-creation.md" title="Story 1.1" section="Full Story" snippet="Establishes public.users, bcrypt hashing, email verification service (SendGrid/SES), password policy (min 12, complexity), Google OAuth registration, auth_provider field." />
      <doc path="docs/stories/1-3-team-member-invitation.md" title="Story 1.3" section="Full Story" snippet="Email template patterns (branded, mobile-responsive, CTA button), async delivery with retry (1s, 4s, 16s exponential backoff), audit logging for email actions." />
      <doc path="docs/stories/1-5-login-session-management.md" title="Story 1.5" section="Full Story" snippet="AuthService.logout_all() invalidates ALL refresh tokens via user_sessions:{user_id} Redis set. Redis key structure: refresh:{sha256(token)} for session data, login_attempts:{email} for rate limiting." />
    </docs>

    <code>
      <!-- Existing code artifacts -->
      <artifact path="src/test-utils/tenant-isolation.ts" kind="test-utility" symbol="createTestTenant, cleanupTestTenant, setTenantContext" lines="1-302" reason="Tenant isolation for integration tests. Password reset operates on public schema (public.users, public.password_resets) but tests may need tenant context for full auth flow testing." />
      <artifact path="tests/conftest.py" kind="pytest-fixtures" symbol="db_pool, test_tenant, tenant_connection" lines="1-170" reason="Pytest fixtures for async DB tests. Use db_pool for public schema operations (password_resets table is in public schema)." />
      <artifact path="scripts/dev-seed.ts" kind="seed-script" symbol="seedUsers, DEFAULT_PASSWORD_HASH" lines="1-284" reason="Dev seed with bcrypt hash for 'password123'. Useful for testing password reset — can verify old password check works against known hash." />

      <!-- Planned code artifacts (created by predecessor stories) -->
      <artifact path="src/services/auth_service.py" kind="service" symbol="AuthService.logout_all()" reason="[PLANNED by Story 1.5] Called after successful password reset to invalidate all sessions. Uses user_sessions:{user_id} Redis set to find and delete all refresh tokens." />
      <artifact path="src/api/v1/auth/" kind="api-routes" symbol="login, refresh, logout, sessions" reason="[PLANNED by Story 1.5] Existing auth routes. This story adds forgot-password and reset-password endpoints to the same router." />
      <artifact path="src/middleware/auth.py" kind="middleware" symbol="JWTAuthMiddleware" reason="[PLANNED by Story 1.5] Auth middleware. Reset endpoints (forgot-password, reset-password) must be EXEMPT from auth (public endpoints)." />
      <artifact path="src/templates/email/invitation.html" kind="email-template" symbol="invitation_email" reason="[PLANNED by Story 1.3] Reference for email template patterns — branded, mobile-responsive, CTA button styling." />
      <artifact path="src/pages/auth/login/" kind="react-page" symbol="LoginPage" reason="[PLANNED by Story 1.5] Login page. This story adds 'Forgot Password?' link to this page." />

      <!-- Planned code artifacts (to be created in this story) -->
      <artifact path="src/services/password_reset_service.py" kind="service" symbol="PasswordResetService" reason="[PLANNED] request_reset(), validate_token(), reset_password(), invalidate_previous_tokens(). Core password reset logic." />
      <artifact path="src/models/password_reset.py" kind="model" symbol="PasswordReset" reason="[PLANNED] SQLAlchemy model for public.password_resets table." />
      <artifact path="src/templates/email/password-reset.html" kind="email-template" symbol="password_reset_email" reason="[PLANNED] Branded HTML template with Reset Password CTA, expiry notice, security notice." />
      <artifact path="src/templates/email/password-reset-google.html" kind="email-template" symbol="password_reset_google_email" reason="[PLANNED] Alternative email for Google-only accounts directing user to Google Sign-In." />
      <artifact path="src/pages/auth/forgot-password/" kind="react-page" symbol="ForgotPasswordPage" reason="[PLANNED] Email input form, always-success message, rate limit handling." />
      <artifact path="src/pages/auth/reset-password/" kind="react-page" symbol="ResetPasswordPage" reason="[PLANNED] Token validation, new password + confirm form, strength indicator (reuse from Story 1.1), error states." />
    </code>

    <dependencies>
      <note>No package.json or pyproject.toml in repo yet. Dependencies specified in planning docs.</note>
      <planned-backend>
        <dep name="Python" version="3.11+" />
        <dep name="FastAPI" role="Web framework, async endpoints" />
        <dep name="SQLAlchemy" role="ORM for public.password_resets" />
        <dep name="Alembic" role="Database migrations" />
        <dep name="asyncpg" role="Async PostgreSQL driver" />
        <dep name="bcrypt" role="Password hashing and old-password comparison" />
        <dep name="Redis" version="7+" role="Rate limiting counters, session invalidation (via AuthService)" />
        <dep name="SendGrid/AWS SES" role="Transactional email delivery" />
        <dep name="Pydantic" role="Request/response validation" />
        <dep name="pytest" role="Testing framework" />
      </planned-backend>
      <planned-frontend>
        <dep name="React" version="18" />
        <dep name="Vite" role="Build tool" />
        <dep name="Tailwind CSS" role="Utility-first styling" />
        <dep name="shadcn/ui" role="UI components (Input, Button, Card)" />
        <dep name="react-router-dom" role="Routing (/forgot-password, /reset-password)" />
        <dep name="Vitest" role="Frontend testing" />
        <dep name="React Testing Library" role="Component testing" />
      </planned-frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint id="1" category="no-enumeration">POST /forgot-password ALWAYS returns 200 with identical message and timing, regardless of email existence. Use constant-time operations (dummy bcrypt hash for non-existent emails) to prevent timing attacks.</constraint>
    <constraint id="2" category="token-security">Reset tokens: secrets.token_urlsafe(32) = 256 bits entropy. Stored as SHA-256 hash in DB (never plaintext). Single-use: marked used_at after successful reset. 1-hour expiry.</constraint>
    <constraint id="3" category="previous-invalidation">When new reset requested, all previous unused tokens for same user are invalidated (set used_at = now()). Only latest token works.</constraint>
    <constraint id="4" category="session-invalidation">After successful password reset, call AuthService.logout_all() to invalidate ALL refresh tokens in Redis. Forces re-authentication with new password.</constraint>
    <constraint id="5" category="password-policy">Same policy as Story 1.1: min 12 chars, uppercase, lowercase, number, special character. Additionally: new password cannot be same as old password (bcrypt compare).</constraint>
    <constraint id="6" category="google-accounts">Users with auth_provider='google' only (no local password) get alternative email: "Your account uses Google Sign-In. Use the Google login button instead." No reset token generated for these accounts.</constraint>
    <constraint id="7" category="rate-limiting">3 requests/email/hour on forgot-password. 5 attempts/token/hour on reset-password. 10 attempts/IP/hour global. All Redis-backed. HTTP 429 with Retry-After header.</constraint>
    <constraint id="8" category="audit">All actions logged with timestamp, IP, user_agent: reset requested (email), email sent (delivery status), reset completed (user_id), reset failed (reason). Internal failure reasons NOT exposed to client.</constraint>
    <constraint id="9" category="public-endpoints">Both forgot-password and reset-password endpoints must be EXEMPT from JWT auth middleware (public endpoints). Users are unauthenticated when resetting.</constraint>
    <constraint id="10" category="email-delivery">Async, non-blocking. Retry: 3 attempts with exponential backoff (1s, 4s, 16s). Reuse existing email service from Story 1.1/1.3.</constraint>
  </constraints>

  <interfaces>
    <interface name="POST /api/v1/auth/forgot-password" kind="REST" signature="POST /api/v1/auth/forgot-password { email: string } → 200 { message: 'If an account with that email exists, we have sent a password reset link.' }" path="src/api/v1/auth/" notes="Public endpoint. ALWAYS returns 200 (no enumeration). Rate-limited: 3/email/hour. Triggers async email if email exists." />
    <interface name="GET /api/v1/auth/reset-password" kind="REST" signature="GET /api/v1/auth/reset-password?token={token} → 200 { valid: bool, email: 'a***@example.com' } | 400 { error: 'token_invalid' | 'token_expired' | 'token_used' }" path="src/api/v1/auth/" notes="Public endpoint. Validates token, returns partially masked email for UX confirmation. Rate-limited: 5/token/hour." />
    <interface name="POST /api/v1/auth/reset-password" kind="REST" signature="POST /api/v1/auth/reset-password { token: string, new_password: string } → 200 { message: 'Password reset successfully' } | 400 { error: ... }" path="src/api/v1/auth/" notes="Public endpoint. Validates token + password policy + not-same-as-old. Updates hash, marks token used, calls logout_all. Rate-limited: 5/token/hour." />
    <interface name="PasswordResetService.request_reset()" kind="service-method" signature="async request_reset(email: str, ip: str, user_agent: str) → None" path="src/services/password_reset_service.py" notes="Looks up user, generates token, stores hash, invalidates previous tokens, triggers email. No-op (but still logs) for non-existent emails." />
    <interface name="PasswordResetService.validate_token()" kind="service-method" signature="async validate_token(token: str) → PasswordResetRecord | None" path="src/services/password_reset_service.py" notes="Hashes token (SHA-256), looks up in DB, checks not expired, not used. Returns record with user_id and email if valid." />
    <interface name="PasswordResetService.reset_password()" kind="service-method" signature="async reset_password(token: str, new_password: str, ip: str, user_agent: str) → None" path="src/services/password_reset_service.py" notes="Validates token, checks password policy, checks not same as old, updates public.users.password_hash, marks token used, calls AuthService.logout_all(user_id)." />
    <interface name="public.password_resets schema" kind="database-table" signature="id UUID PK, user_id UUID FK(public.users), token_hash VARCHAR(64) INDEXED, expires_at TIMESTAMPTZ, used_at TIMESTAMPTZ NULL, created_at TIMESTAMPTZ" path="N/A (public schema)" notes="New table. Token stored as SHA-256 hash. Partial unique: only one active (used_at IS NULL) token per user." />
    <interface name="AuthService.logout_all()" kind="service-method" signature="async logout_all(user_id: UUID) → int (sessions_revoked)" path="src/services/auth_service.py" notes="[From Story 1.5] Deletes all entries in user_sessions:{user_id} Redis set and corresponding refresh:{hash} keys. Called after password reset." />
  </interfaces>

  <tests>
    <standards>Backend: Pytest with async test client (httpx.AsyncClient), PostgreSQL test database with per-test transaction rollback. Redis required for rate limiting and session invalidation tests. Frontend: Vitest + React Testing Library. Coverage target: 80%+ for new code. Email mocked (verify template + delivery calls). Timing tests for no-enumeration.</standards>
    <locations>
      <loc>tests/ (Python backend — pytest)</loc>
      <loc>tests/integration/ (API integration tests)</loc>
      <loc>src/**/__tests__/ (Frontend — Vitest)</loc>
    </locations>
    <ideas>
      <group ac="1" title="Forgot Password Link">
        <idea>Login page renders 'Forgot Password?' link</idea>
        <idea>Link navigates to /forgot-password</idea>
      </group>
      <group ac="2" title="Reset Request Form">
        <idea>Valid email → 200 with success message</idea>
        <idea>Non-existent email → 200 with SAME success message (no enumeration)</idea>
        <idea>Invalid email format → 422 validation error</idea>
        <idea>Timing: response time identical for existing vs non-existing email (within 10ms)</idea>
      </group>
      <group ac="3" title="Token Generation">
        <idea>Token is 32 bytes (256 bits) entropy, URL-safe</idea>
        <idea>Token stored as SHA-256 hash (not plaintext)</idea>
        <idea>Previous unused tokens invalidated when new reset requested</idea>
        <idea>Google-only account gets alternative email (no token generated)</idea>
      </group>
      <group ac="4" title="Email Delivery">
        <idea>Email contains user name, Reset Password button, expiry notice</idea>
        <idea>Email sent asynchronously (API returns before email sent)</idea>
        <idea>Retry on failure: 3 attempts with exponential backoff</idea>
        <idea>Google-only email contains "Use Google Sign-In" message</idea>
      </group>
      <group ac="5" title="Reset Password Page">
        <idea>Valid token → shows password form with email confirmation</idea>
        <idea>Expired token → error page with link to forgot-password</idea>
        <idea>Used token → error page</idea>
        <idea>Invalid token → error page</idea>
        <idea>Password strength indicator matches Story 1.1 policy</idea>
        <idea>Passwords must match (confirm field validation)</idea>
      </group>
      <group ac="6" title="Password Update">
        <idea>Valid reset → password_hash updated in public.users</idea>
        <idea>Token marked as used (used_at set)</idea>
        <idea>All sessions invalidated (Redis refresh tokens deleted)</idea>
        <idea>Redirect to login with success message</idea>
        <idea>Weak password → 400 with policy violation details</idea>
        <idea>Same-as-old password → 400 "Cannot reuse current password"</idea>
        <idea>Expired token on submit → 400 (race condition: valid on load, expired on submit)</idea>
      </group>
      <group ac="7" title="Rate Limiting">
        <idea>4th forgot-password request for same email in 1 hour → 429</idea>
        <idea>6th reset attempt with same token → 429</idea>
        <idea>11th request from same IP → 429</idea>
        <idea>Different emails from same IP: independent email limits</idea>
      </group>
      <group ac="8" title="Audit Trail">
        <idea>Reset requested → audit entry with email, IP, user_agent</idea>
        <idea>Email sent → audit entry with delivery status</idea>
        <idea>Reset completed → audit entry with user_id</idea>
        <idea>Reset failed → audit entry with reason (expired, used, policy violation)</idea>
      </group>
      <group ac="frontend" title="Frontend Tests">
        <idea>Forgot password form renders email input and submit button</idea>
        <idea>Success message shown after submission (always)</idea>
        <idea>Reset page validates token on mount</idea>
        <idea>Password strength indicator updates in real-time</idea>
        <idea>Confirm password mismatch shows error</idea>
        <idea>Success redirect to /login with banner</idea>
        <idea>Error states: expired, used, invalid token</idea>
      </group>
    </ideas>
  </tests>
</story-context>
