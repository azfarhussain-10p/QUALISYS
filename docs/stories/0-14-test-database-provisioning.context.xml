<story-context id="bmad/bmm/workflows/4-implementation/story-context" v="1.0">
  <metadata>
    <epicId>0</epicId>
    <storyId>14</storyId>
    <title>Test Database Provisioning</title>
    <status>ready-for-dev</status>
    <generatedAt>2026-01-23</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/0-14-test-database-provisioning.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>QA Engineer</asA>
    <iWant>a dedicated test database with proper isolation</iWant>
    <soThat>tests don't interfere with development or staging data and can run in parallel safely</soThat>
    <tasks>
      <task id="1" name="Test Database Creation" acs="1,8">
        <subtask>1.1-1.5 Create qualisys_test database, test_user role with limited permissions</subtask>
      </task>
      <task id="2" name="Test Tenant Schemas" acs="5,7">
        <subtask>2.1-2.5 Create test tenant schemas, apply RLS, run isolation verification</subtask>
      </task>
      <task id="3" name="Connection Configuration" acs="2,3,6">
        <subtask>3.1-3.5 Store connection strings in Secrets Manager, GitHub, Docker Compose</subtask>
      </task>
      <task id="4" name="Database Reset Mechanism" acs="4,9">
        <subtask>4.1-4.5 Create reset script, integrate into test setup, add npm scripts</subtask>
      </task>
      <task id="5" name="Migration Support" acs="9,10">
        <subtask>5.1-5.5 Configure migrations for test DB, verify performance</subtask>
      </task>
      <task id="6" name="Validation and Documentation" acs="all">
        <subtask>6.1-6.5 Run full test suite, verify CI/CD, document setup</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">Separate PostgreSQL database created: qualisys_test</ac>
    <ac id="2">Test database accessible from CI/CD runners</ac>
    <ac id="3">Test database accessible from local development</ac>
    <ac id="4">Database reset mechanism for clean test runs</ac>
    <ac id="5">Test tenant schemas created: tenant_test_1, tenant_test_2, tenant_test_3</ac>
    <ac id="6">Test database connection string stored in secrets</ac>
    <ac id="7">Isolation verification: tenant_test_1 cannot access tenant_test_2 data</ac>
    <ac id="8">Test database user has appropriate permissions (not superuser)</ac>
    <ac id="9">Database migrations run successfully on test database</ac>
    <ac id="10">Test database performance comparable to production config</ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-specs/tech-spec-epic-0.md</path>
        <title>Epic 0 Technical Specification</title>
        <section>Data Models and Contracts</section>
        <snippet>Schema-per-tenant design with RLS policies. app_user role with NO SUPERUSER, NO BYPASSRLS. Test database mirrors production schema structure.</snippet>
      </doc>
      <doc>
        <path>docs/tech-specs/tech-spec-epic-0.md</path>
        <title>Epic 0 Technical Specification</title>
        <section>Security</section>
        <snippet>Test database isolated from production. RLS policies prevent cross-tenant access. Isolation verification tests required on staging database.</snippet>
      </doc>
      <doc>
        <path>docs/epics/epic-0-infrastructure.md</path>
        <title>Epic 0: Infrastructure Foundation</title>
        <section>Story 0.14</section>
        <snippet>Test Database Provisioning: Separate database, test tenant schemas, reset mechanism, CI/CD and local development access, isolation verification.</snippet>
      </doc>
      <doc>
        <path>docs/architecture/architecture.md</path>
        <title>System Architecture</title>
        <section>Multi-Tenant Database</section>
        <snippet>Schema-per-tenant with RLS defense-in-depth. Test infrastructure must validate tenant isolation before production deployment.</snippet>
      </doc>
      <doc>
        <path>docs/stories/0-4-postgresql-multi-tenant-database.md</path>
        <title>Story 0.4: PostgreSQL Multi-Tenant Database</title>
        <section>RLS Configuration</section>
        <snippet>Prerequisite: RDS instance with qualisys_master database. Test database uses same RLS patterns and policy structure.</snippet>
      </doc>
    </docs>

    <code>
      <note>Test database extends production database patterns from Story 0.4.</note>
      <prerequisites>
        <story id="0-4-postgresql-multi-tenant-database" status="ready-for-dev">
          <provides>RDS instance, RLS policy patterns, app_user role design</provides>
        </story>
      </prerequisites>
      <expectedStructure>
        <folder path="scripts" purpose="Database management scripts" />
        <file path="scripts/db-reset.ts" purpose="Database reset script" />
        <file path="scripts/init-test-db.sql" purpose="Test database initialization" />
        <file path="scripts/create-test-tenants.sql" purpose="Test tenant schema creation" />
        <file path="scripts/isolation-test.sql" purpose="RLS isolation verification" />
        <file path="scripts/seed-test.ts" purpose="Test data seeding" />
        <file path="docker-compose.yml" purpose="Updated with test database service" />
        <file path=".env.test.example" purpose="Test environment template" />
        <file path="jest.integration.config.js" purpose="Integration test configuration" />
        <file path="CONTRIBUTING.md" purpose="Updated with test database docs" />
      </expectedStructure>
      <outputs description="Test database infrastructure">
        <output name="qualisys_test database" consumers="Story 0.10, 0.15, 0.16, 0.18" />
        <output name="test_user role" consumers="CI/CD, local development" />
        <output name="test tenant schemas" consumers="Integration tests, isolation tests" />
        <output name="reset scripts" consumers="Test framework beforeAll hooks" />
      </outputs>
      <databaseCreationSQL>
        <![CDATA[
-- Create test database
CREATE DATABASE qualisys_test;

-- Connect to test database
\c qualisys_test

-- Create test user (CRITICAL: NO SUPERUSER, NO BYPASSRLS)
CREATE ROLE test_user WITH LOGIN PASSWORD 'stored_in_secrets_manager';
GRANT CREATE ON DATABASE qualisys_test TO test_user;
GRANT USAGE ON SCHEMA public TO test_user;

-- Verify test_user permissions
SELECT rolname, rolsuper, rolbypassrls
FROM pg_roles
WHERE rolname = 'test_user';
-- Expected: rolsuper=f, rolbypassrls=f
        ]]>
      </databaseCreationSQL>
      <tenantSchemaSQL>
        <![CDATA[
-- Create test tenant schemas
CREATE SCHEMA IF NOT EXISTS tenant_test_1;
CREATE SCHEMA IF NOT EXISTS tenant_test_2;
CREATE SCHEMA IF NOT EXISTS tenant_test_3;

-- Grant test_user access to schemas
GRANT ALL ON SCHEMA tenant_test_1 TO test_user;
GRANT ALL ON SCHEMA tenant_test_2 TO test_user;
GRANT ALL ON SCHEMA tenant_test_3 TO test_user;

-- Example table with RLS
CREATE TABLE tenant_test_1.projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL,
    name VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Enable RLS
ALTER TABLE tenant_test_1.projects ENABLE ROW LEVEL SECURITY;

-- Create RLS policy
CREATE POLICY tenant_isolation ON tenant_test_1.projects
    USING (tenant_id = current_setting('app.current_tenant')::uuid);

-- Force RLS for table owner too
ALTER TABLE tenant_test_1.projects FORCE ROW LEVEL SECURITY;
        ]]>
      </tenantSchemaSQL>
      <isolationTestSQL>
        <![CDATA[
-- isolation_test.sql
-- Verifies RLS policies prevent cross-tenant access

-- Set tenant context to tenant_test_1
SET LOCAL app.current_tenant = '11111111-1111-1111-1111-111111111111';

-- Insert data as tenant_test_1
INSERT INTO tenant_test_1.projects (tenant_id, name)
VALUES ('11111111-1111-1111-1111-111111111111', 'Tenant 1 Project');

-- Switch to tenant_test_2 context
SET LOCAL app.current_tenant = '22222222-2222-2222-2222-222222222222';

-- Attempt to read tenant_test_1 data (should return 0 rows)
SELECT COUNT(*) AS visible_rows FROM tenant_test_1.projects;
-- Expected: 0 (RLS blocks access)

-- Verify isolation
DO $$
DECLARE
    row_count INTEGER;
BEGIN
    SELECT COUNT(*) INTO row_count FROM tenant_test_1.projects;
    IF row_count > 0 THEN
        RAISE EXCEPTION 'RLS VIOLATION: Tenant 2 can see Tenant 1 data!';
    END IF;
    RAISE NOTICE 'RLS isolation test PASSED';
END $$;
        ]]>
      </isolationTestSQL>
      <resetScriptTemplate>
        <![CDATA[
// scripts/db-reset.ts
import { Pool } from 'pg';

const pool = new Pool({
  connectionString: process.env.TEST_DATABASE_URL,
});

export async function resetDatabase(): Promise<void> {
  const client = await pool.connect();
  const schemas = ['tenant_test_1', 'tenant_test_2', 'tenant_test_3'];

  try {
    await client.query(`SET session_replication_role = 'replica'`);

    for (const schema of schemas) {
      const tables = await client.query(`
        SELECT tablename FROM pg_tables WHERE schemaname = $1
      `, [schema]);

      for (const row of tables.rows) {
        await client.query(`TRUNCATE TABLE ${schema}.${row.tablename} CASCADE`);
      }
    }

    await client.query(`SET session_replication_role = 'origin'`);
    console.log('Database reset complete');
  } finally {
    client.release();
  }
}

// Run if called directly
if (require.main === module) {
  resetDatabase().then(() => process.exit(0)).catch(e => {
    console.error(e);
    process.exit(1);
  });
}
        ]]>
      </resetScriptTemplate>
      <dockerComposeService>
        <![CDATA[
# docker-compose.yml - test database service
services:
  postgres-test:
    image: postgres:15-alpine
    container_name: qualisys-postgres-test
    environment:
      POSTGRES_DB: qualisys_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    ports:
      - "5433:5432"
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
      - ./scripts/init-test-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d qualisys_test"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  postgres-test-data:
        ]]>
      </dockerComposeService>
      <cicdServiceContainer>
        <![CDATA[
# GitHub Actions service container
services:
  postgres:
    image: postgres:15
    env:
      POSTGRES_DB: qualisys_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    options: >-
      --health-cmd pg_isready
      --health-interval 10s
      --health-timeout 5s
      --health-retries 5
    ports:
      - 5432:5432
        ]]>
      </cicdServiceContainer>
      <packageJsonScripts>
        <![CDATA[
{
  "scripts": {
    "db:migrate:test": "DATABASE_URL=$TEST_DATABASE_URL npx prisma migrate deploy",
    "db:reset:test": "ts-node scripts/db-reset.ts",
    "db:seed:test": "DATABASE_URL=$TEST_DATABASE_URL ts-node scripts/seed-test.ts",
    "db:isolation:test": "psql $TEST_DATABASE_URL -f scripts/isolation-test.sql",
    "test:integration": "jest --config jest.integration.config.js",
    "test:integration:watch": "jest --config jest.integration.config.js --watch"
  }
}
        ]]>
      </packageJsonScripts>
    </code>

    <dependencies>
      <npm>
        <package name="pg" version="^8.0.0" purpose="PostgreSQL client" />
        <package name="@types/pg" version="^8.0.0" purpose="TypeScript types" dev="true" />
        <package name="prisma" version="^5.0.0" purpose="Database migrations" dev="true" />
        <package name="ts-node" version="^10.0.0" purpose="Run TypeScript scripts" dev="true" />
      </npm>
      <postgres>
        <extension name="uuid-ossp" purpose="UUID generation" />
        <extension name="pgcrypto" purpose="gen_random_uuid function" />
      </postgres>
      <secrets>
        <secret name="TEST_DATABASE_URL" purpose="Test database connection string" />
        <secret name="test_user password" purpose="Test database user password" location="AWS Secrets Manager" />
      </secrets>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="Security" critical="true">test_user must NOT have superuser privilege</constraint>
    <constraint source="Security" critical="true">test_user must NOT have bypassrls privilege</constraint>
    <constraint source="Security" critical="true">RLS policies must prevent cross-tenant data access</constraint>
    <constraint source="Security">Test database credentials stored in Secrets Manager, not in code</constraint>
    <constraint source="Performance">Database reset must complete in less than 30 seconds</constraint>
    <constraint source="Consistency">Test database schema must match production exactly</constraint>
    <constraint source="Isolation">Test database separate from development and staging data</constraint>
    <constraint source="Dependency">Story 0.4 (PostgreSQL) must be complete for RDS instance</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PostgreSQL Connection</name>
      <kind>Database protocol</kind>
      <signature>postgresql://test_user:password@host:5432/qualisys_test</signature>
      <path>Environment variable TEST_DATABASE_URL</path>
    </interface>
    <interface>
      <name>Database Reset API</name>
      <kind>Node.js script</kind>
      <signature>npm run db:reset:test</signature>
      <path>scripts/db-reset.ts</path>
    </interface>
    <interface>
      <name>Migration CLI</name>
      <kind>Prisma CLI</kind>
      <signature>npm run db:migrate:test</signature>
      <path>prisma/migrations/</path>
    </interface>
    <interface>
      <name>Isolation Test</name>
      <kind>SQL script</kind>
      <signature>npm run db:isolation:test</signature>
      <path>scripts/isolation-test.sql</path>
    </interface>
    <interface>
      <name>Docker Compose Service</name>
      <kind>Container</kind>
      <signature>docker-compose up postgres-test</signature>
      <path>docker-compose.yml</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Test database testing validates database creation, user permissions, RLS isolation, reset functionality, and CI/CD integration. QA Lead and DevOps verify configuration. Integration tests run against test database to validate real queries.
    </standards>
    <locations>
      <location>psql commands for database verification</location>
      <location>GitHub Actions for CI/CD integration testing</location>
      <location>Local Docker Compose for development testing</location>
      <location>Jest integration test suite</location>
    </locations>
    <ideas>
      <idea ac="1">psql -c "\l" shows qualisys_test database in list</idea>
      <idea ac="2">GitHub Actions workflow connects and runs SELECT 1 successfully</idea>
      <idea ac="3">docker-compose up postgres-test, then psql connects on port 5433</idea>
      <idea ac="4">Run db:reset:test, verify all tables truncated, time less than 30s</idea>
      <idea ac="5">psql -c "\dn" shows tenant_test_1, tenant_test_2, tenant_test_3 schemas</idea>
      <idea ac="6">GitHub Secrets contains TEST_DATABASE_URL (masked in logs)</idea>
      <idea ac="7">Run isolation-test.sql, verify "RLS isolation test PASSED" message</idea>
      <idea ac="8">psql -c "SELECT rolsuper, rolbypassrls FROM pg_roles WHERE rolname='test_user'" shows f,f</idea>
      <idea ac="9">npm run db:migrate:test completes without errors</idea>
      <idea ac="10">Run same query on test and staging, compare execution time within 2x</idea>
      <idea ac="rls-bypass">Attempt SET LOCAL row_security = off as test_user, verify permission denied</idea>
      <idea ac="parallel">Run two test suites in parallel using different tenant schemas</idea>
      <idea ac="seed">After reset and seed, verify expected baseline data exists</idea>
    </ideas>
  </tests>
</story-context>
