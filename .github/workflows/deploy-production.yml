# Deploy Production Workflow
# Story: 0-8 GitHub Actions Workflow Setup
# AC: 3 - Deploy production with manual trigger (workflow_dispatch)
# AC: 7 - Least-privilege permissions
# AC: 9 - GitHub Environments with protection rules
# Supports both AWS and Azure via CLOUD_PROVIDER repository variable

name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        required: true
        type: string
        description: "Image tag to deploy (git SHA from staging)"
      dry_run:
        required: false
        type: boolean
        default: false
        description: "Dry run - validate without deploying"

permissions:
  contents: read
  packages: write
  id-token: write
  security-events: write

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ===================================================================
  # Validate Image Exists
  # ===================================================================
  validate:
    name: Validate Image
    runs-on: ubuntu-latest
    steps:
      # --- AWS validation ---
      - name: Configure AWS credentials
        if: vars.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify images exist (AWS ECR)
        if: vars.CLOUD_PROVIDER == 'aws'
        run: |
          aws ecr describe-images \
            --repository-name qualisys-api \
            --image-ids imageTag=${{ inputs.image_tag }} \
            --region ${{ secrets.AWS_REGION }}

          aws ecr describe-images \
            --repository-name qualisys-web \
            --image-ids imageTag=${{ inputs.image_tag }} \
            --region ${{ secrets.AWS_REGION }}

      - name: Check ECR scan results
        if: vars.CLOUD_PROVIDER == 'aws'
        run: |
          echo "=== API Image Scan ==="
          aws ecr describe-image-scan-findings \
            --repository-name qualisys-api \
            --image-id imageTag=${{ inputs.image_tag }} \
            --query 'imageScanFindings.findingSeverityCounts' \
            --region ${{ secrets.AWS_REGION }} || echo "No scan results"

          echo "=== Web Image Scan ==="
          aws ecr describe-image-scan-findings \
            --repository-name qualisys-web \
            --image-id imageTag=${{ inputs.image_tag }} \
            --query 'imageScanFindings.findingSeverityCounts' \
            --region ${{ secrets.AWS_REGION }} || echo "No scan results"

      # --- Azure validation ---
      - name: Login to Azure
        if: vars.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify images exist (Azure ACR)
        if: vars.CLOUD_PROVIDER == 'azure'
        run: |
          az acr repository show-tags \
            --name ${{ secrets.ACR_REGISTRY_NAME }} \
            --repository qualisys-api \
            --query "[?contains(@, '${{ inputs.image_tag }}')]" \
            --output tsv | grep -q "${{ inputs.image_tag }}" || \
            (echo "API image tag not found" && exit 1)

          az acr repository show-tags \
            --name ${{ secrets.ACR_REGISTRY_NAME }} \
            --repository qualisys-web \
            --query "[?contains(@, '${{ inputs.image_tag }}')]" \
            --output tsv | grep -q "${{ inputs.image_tag }}" || \
            (echo "Web image tag not found" && exit 1)

  # ===================================================================
  # Deploy to Production (requires environment approval)
  # ===================================================================
  deploy-production:
    name: Deploy to Production
    needs: [validate]
    if: ${{ !inputs.dry_run }}
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: production
      image_tag: ${{ inputs.image_tag }}
      namespace: production
    secrets:
      # AWS
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
      KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}
      # Azure
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ACR_REGISTRY_NAME: ${{ secrets.ACR_REGISTRY_NAME }}
      AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
      AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}

  # ===================================================================
  # Post-Deployment Smoke Tests
  # ===================================================================
  smoke-tests:
    name: Smoke Tests
    needs: [deploy-production]
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- AWS kubeconfig ---
      - name: Configure AWS credentials
        if: vars.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup kubeconfig (AWS)
        if: vars.CLOUD_PROVIDER == 'aws'
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # --- Azure kubeconfig ---
      - name: Login to Azure
        if: vars.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup kubeconfig (Azure)
        if: vars.CLOUD_PROVIDER == 'azure'
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      # --- Shared smoke tests ---
      - name: Verify pods are running
        run: |
          echo "=== Checking pod status ==="
          kubectl get pods -n production -l app.kubernetes.io/part-of=qualisys
          READY=$(kubectl get pods -n production -l app.kubernetes.io/part-of=qualisys -o jsonpath='{range .items[*]}{.status.containerStatuses[0].ready}{"\n"}{end}' | grep -c true || echo 0)
          TOTAL=$(kubectl get pods -n production -l app.kubernetes.io/part-of=qualisys --no-headers | wc -l)
          echo "Ready pods: ${READY}/${TOTAL}"

      - name: Health check - API
        run: |
          API_URL=$(kubectl get ingress -n production -o jsonpath='{.items[0].spec.rules[0].host}' 2>/dev/null || echo "")
          if [ -n "$API_URL" ]; then
            echo "Checking API health at https://${API_URL}/api/health..."
            curl -sf "https://${API_URL}/api/health" --max-time 30 || echo "API health check endpoint not yet available"
          else
            echo "No ingress found, skipping HTTP health check"
          fi

      - name: Verify deployment image tags
        run: |
          echo "=== Deployed Images ==="
          kubectl get deployments -n production -o jsonpath='{range .items[*]}{.metadata.name}: {.spec.template.spec.containers[0].image}{"\n"}{end}'

  # ===================================================================
  # Notify
  # ===================================================================
  notify:
    name: Notify
    needs: [smoke-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify Slack on success
        if: needs.smoke-tests.result == 'success' && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d "{
              \"text\": \":rocket: Production deployment successful\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \":rocket: *Production deployment successful*\n*Cloud:* \`${{ vars.CLOUD_PROVIDER }}\`\n*Image:* \`${{ inputs.image_tag }}\`\n*Triggered by:* ${GITHUB_ACTOR}\n*Run:* <${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|View>\"
                  }
                }
              ]
            }"

      - name: Notify Slack on failure
        if: needs.smoke-tests.result == 'failure' && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d "{
              \"text\": \":rotating_light: Production deployment FAILED\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \":rotating_light: *Production deployment FAILED*\n*Cloud:* \`${{ vars.CLOUD_PROVIDER }}\`\n*Image:* \`${{ inputs.image_tag }}\`\n*Triggered by:* ${GITHUB_ACTOR}\n*Run:* <${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|View logs>\"
                  }
                }
              ]
            }"
