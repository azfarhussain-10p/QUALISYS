# Deploy Production Workflow
# Story: 0-8 GitHub Actions Workflow Setup, 0-12 Production Deployment with Approval Gate
# AC (0-8): 3 - Deploy production with manual trigger (workflow_dispatch)
# AC (0-12): 1 - Manual trigger only, 3 - Approval required, 4 - Canary rollout (10%→50%→100%)
# AC (0-12): 5 - Smoke tests after each phase, 6 - Auto-rollback on failure
# AC (0-12): 8 - Audit trail (who, when, what), 10 - <10 min total deployment time
# Supports both AWS and Azure via CLOUD_PROVIDER repository variable

name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        required: true
        type: string
        description: "Image tag to deploy (git SHA from staging)"
      skip_canary:
        required: false
        type: boolean
        default: false
        description: "Skip canary phase (emergency hotfix only)"
      dry_run:
        required: false
        type: boolean
        default: false
        description: "Dry run - validate without deploying"

permissions:
  contents: read
  packages: write
  id-token: write
  deployments: write

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ===================================================================
  # Validate Image Exists
  # ===================================================================
  validate:
    name: Validate Image
    runs-on: ubuntu-latest
    steps:
      - name: Audit - Deployment initiated
        run: |
          echo "=========================================="
          echo "PRODUCTION DEPLOYMENT AUDIT LOG"
          echo "=========================================="
          echo "Initiated by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Image tag: ${{ inputs.image_tag }}"
          echo "Skip canary: ${{ inputs.skip_canary }}"
          echo "Dry run: ${{ inputs.dry_run }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run number: ${{ github.run_number }}"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "=========================================="

      # --- AWS validation ---
      - name: Configure AWS credentials
        if: vars.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify images exist (AWS ECR)
        if: vars.CLOUD_PROVIDER == 'aws'
        run: |
          aws ecr describe-images \
            --repository-name qualisys-api \
            --image-ids imageTag=${{ inputs.image_tag }} \
            --region ${{ secrets.AWS_REGION }}

          aws ecr describe-images \
            --repository-name qualisys-web \
            --image-ids imageTag=${{ inputs.image_tag }} \
            --region ${{ secrets.AWS_REGION }}

      - name: Check ECR scan results
        if: vars.CLOUD_PROVIDER == 'aws'
        run: |
          echo "=== API Image Scan ==="
          aws ecr describe-image-scan-findings \
            --repository-name qualisys-api \
            --image-id imageTag=${{ inputs.image_tag }} \
            --query 'imageScanFindings.findingSeverityCounts' \
            --region ${{ secrets.AWS_REGION }} || echo "No scan results"

          echo "=== Web Image Scan ==="
          aws ecr describe-image-scan-findings \
            --repository-name qualisys-web \
            --image-id imageTag=${{ inputs.image_tag }} \
            --query 'imageScanFindings.findingSeverityCounts' \
            --region ${{ secrets.AWS_REGION }} || echo "No scan results"

      # --- Azure validation ---
      - name: Login to Azure
        if: vars.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify images exist (Azure ACR)
        if: vars.CLOUD_PROVIDER == 'azure'
        run: |
          az acr repository show-tags \
            --name ${{ secrets.ACR_REGISTRY_NAME }} \
            --repository qualisys-api \
            --query "[?contains(@, '${{ inputs.image_tag }}')]" \
            --output tsv | grep -q "${{ inputs.image_tag }}" || \
            (echo "API image tag not found" && exit 1)

          az acr repository show-tags \
            --name ${{ secrets.ACR_REGISTRY_NAME }} \
            --repository qualisys-web \
            --query "[?contains(@, '${{ inputs.image_tag }}')]" \
            --output tsv | grep -q "${{ inputs.image_tag }}" || \
            (echo "Web image tag not found" && exit 1)

  # ===================================================================
  # Approval Gate (GitHub Environment Protection)
  # ===================================================================
  approve:
    name: Approval Gate
    needs: [validate]
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Audit - Deployment approved
        run: |
          echo "=========================================="
          echo "PRODUCTION DEPLOYMENT APPROVED"
          echo "=========================================="
          echo "Approved by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Image tag: ${{ inputs.image_tag }}"
          echo "Skip canary: ${{ inputs.skip_canary }}"
          echo "=========================================="

  # ===================================================================
  # Canary Deployment (10% traffic)
  # ===================================================================
  canary:
    name: Canary Deploy (10%)
    needs: [approve]
    if: ${{ !inputs.skip_canary }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- AWS kubeconfig ---
      - name: Configure AWS credentials
        if: vars.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup kubeconfig (AWS)
        if: vars.CLOUD_PROVIDER == 'aws'
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # --- Azure kubeconfig ---
      - name: Login to Azure
        if: vars.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup kubeconfig (Azure)
        if: vars.CLOUD_PROVIDER == 'azure'
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      # --- Set registry variable ---
      - name: Set registry variable
        id: registry
        run: |
          if [ "${{ vars.CLOUD_PROVIDER }}" = "azure" ]; then
            echo "registry=${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io" >> "$GITHUB_OUTPUT"
          else
            echo "registry=${{ secrets.ECR_REGISTRY }}" >> "$GITHUB_OUTPUT"
          fi

      # --- Deploy canary (10%) ---
      - name: Deploy canary (10%)
        run: |
          IMAGE_BASE="${{ steps.registry.outputs.registry }}"
          TAG="${{ inputs.image_tag }}"

          echo "Deploying canary: API + Web with tag ${TAG}"

          # Update canary API deployment
          kubectl set image deployment/qualisys-api-canary \
            qualisys-api="${IMAGE_BASE}/qualisys-api:${TAG}" \
            -n production

          # Update canary Web deployment
          kubectl set image deployment/qualisys-web-canary \
            qualisys-web="${IMAGE_BASE}/qualisys-web:${TAG}" \
            -n production

          # Ensure canary replicas are at 1 (10% of total 10)
          kubectl scale deployment/qualisys-api-canary --replicas=1 -n production
          kubectl scale deployment/qualisys-web-canary --replicas=1 -n production

          # Wait for rollout
          echo "Waiting for canary API rollout..."
          kubectl rollout status deployment/qualisys-api-canary -n production --timeout=120s

          echo "Waiting for canary Web rollout..."
          kubectl rollout status deployment/qualisys-web-canary -n production --timeout=120s

      - name: Audit - Canary deployed
        run: |
          echo "Canary deployed at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "=== Canary Pod Status ==="
          kubectl get pods -n production -l track=canary

      - name: Run smoke tests on canary
        run: |
          chmod +x ./scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh https://app.qualisys.io

      - name: Wait for canary observation (2 min)
        run: |
          echo "Observing canary for 2 minutes..."
          sleep 120

  # ===================================================================
  # Rollout to 50%
  # ===================================================================
  rollout-50:
    name: Rollout to 50%
    needs: [canary]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- AWS kubeconfig ---
      - name: Configure AWS credentials
        if: vars.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup kubeconfig (AWS)
        if: vars.CLOUD_PROVIDER == 'aws'
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # --- Azure kubeconfig ---
      - name: Login to Azure
        if: vars.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup kubeconfig (Azure)
        if: vars.CLOUD_PROVIDER == 'azure'
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Scale to 50% canary
        run: |
          echo "Scaling to 50/50 split..."

          # Scale canary to 5 replicas, stable stays at 5
          kubectl scale deployment/qualisys-api-canary --replicas=5 -n production
          kubectl scale deployment/qualisys-api-stable --replicas=5 -n production
          kubectl scale deployment/qualisys-web-canary --replicas=5 -n production
          kubectl scale deployment/qualisys-web-stable --replicas=5 -n production

          echo "Waiting for scaling..."
          kubectl rollout status deployment/qualisys-api-canary -n production --timeout=120s
          kubectl rollout status deployment/qualisys-web-canary -n production --timeout=120s

      - name: Audit - Rollout at 50%
        run: |
          echo "50% rollout at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "=== All Production Pods ==="
          kubectl get pods -n production -l app.kubernetes.io/part-of=qualisys

      - name: Run smoke tests at 50%
        run: |
          chmod +x ./scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh https://app.qualisys.io

  # ===================================================================
  # Rollout to 100% (Promote canary to stable)
  # ===================================================================
  rollout-100:
    name: Rollout to 100%
    needs: [rollout-50]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- AWS kubeconfig ---
      - name: Configure AWS credentials
        if: vars.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup kubeconfig (AWS)
        if: vars.CLOUD_PROVIDER == 'aws'
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # --- Azure kubeconfig ---
      - name: Login to Azure
        if: vars.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup kubeconfig (Azure)
        if: vars.CLOUD_PROVIDER == 'azure'
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      # --- Set registry variable ---
      - name: Set registry variable
        id: registry
        run: |
          if [ "${{ vars.CLOUD_PROVIDER }}" = "azure" ]; then
            echo "registry=${{ secrets.ACR_REGISTRY_NAME }}.azurecr.io" >> "$GITHUB_OUTPUT"
          else
            echo "registry=${{ secrets.ECR_REGISTRY }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Promote canary to stable (100%)
        run: |
          IMAGE_BASE="${{ steps.registry.outputs.registry }}"
          TAG="${{ inputs.image_tag }}"

          echo "Promoting canary image to stable deployments..."

          # Update stable deployments with canary's image tag
          kubectl set image deployment/qualisys-api-stable \
            qualisys-api="${IMAGE_BASE}/qualisys-api:${TAG}" \
            -n production
          kubectl set image deployment/qualisys-web-stable \
            qualisys-web="${IMAGE_BASE}/qualisys-web:${TAG}" \
            -n production

          # Wait for stable rollout
          echo "Waiting for stable API rollout..."
          kubectl rollout status deployment/qualisys-api-stable -n production --timeout=180s
          echo "Waiting for stable Web rollout..."
          kubectl rollout status deployment/qualisys-web-stable -n production --timeout=180s

          # Scale stable back to full replicas, canary to 1
          kubectl scale deployment/qualisys-api-stable --replicas=9 -n production
          kubectl scale deployment/qualisys-web-stable --replicas=9 -n production
          kubectl scale deployment/qualisys-api-canary --replicas=1 -n production
          kubectl scale deployment/qualisys-web-canary --replicas=1 -n production

      - name: Audit - Full rollout complete
        run: |
          echo "=========================================="
          echo "PRODUCTION DEPLOYMENT COMPLETE"
          echo "=========================================="
          echo "Completed by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Image tag: ${{ inputs.image_tag }}"
          echo "=========================================="
          echo "=== Deployment Status ==="
          kubectl get deployments -n production
          echo "=== Pod Status ==="
          kubectl get pods -n production -l app.kubernetes.io/part-of=qualisys

      - name: Run final smoke tests
        run: |
          chmod +x ./scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh https://app.qualisys.io

  # ===================================================================
  # Direct Deploy (skip canary — emergency hotfix path)
  # ===================================================================
  direct-deploy:
    name: Direct Deploy (Skip Canary)
    needs: [approve]
    if: ${{ inputs.skip_canary && !inputs.dry_run }}
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: production
      image_tag: ${{ inputs.image_tag }}
      namespace: production
    secrets:
      # AWS
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
      KUBECONFIG_BASE64: ${{ secrets.KUBECONFIG_BASE64 }}
      # Azure
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ACR_REGISTRY_NAME: ${{ secrets.ACR_REGISTRY_NAME }}
      AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}
      AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}

  # ===================================================================
  # Post-Deployment Smoke Tests (direct deploy path)
  # ===================================================================
  smoke-tests-direct:
    name: Smoke Tests (Direct)
    needs: [direct-deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- AWS kubeconfig ---
      - name: Configure AWS credentials
        if: vars.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup kubeconfig (AWS)
        if: vars.CLOUD_PROVIDER == 'aws'
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_BASE64 }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      # --- Azure kubeconfig ---
      - name: Login to Azure
        if: vars.CLOUD_PROVIDER == 'azure'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Setup kubeconfig (Azure)
        if: vars.CLOUD_PROVIDER == 'azure'
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: Run smoke tests
        run: |
          chmod +x ./scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh https://app.qualisys.io

      - name: Verify deployment
        run: |
          echo "=== Pod Status ==="
          kubectl get pods -n production -l app.kubernetes.io/part-of=qualisys
          echo "=== Deployed Images ==="
          kubectl get deployments -n production \
            -o jsonpath='{range .items[*]}{.metadata.name}: {.spec.template.spec.containers[0].image}{"\n"}{end}'

  # ===================================================================
  # Notify (both paths converge here)
  # ===================================================================
  notify:
    name: Notify
    needs: [rollout-100, smoke-tests-direct]
    if: always() && !inputs.dry_run
    runs-on: ubuntu-latest
    steps:
      - name: Determine deployment result
        id: result
        run: |
          # Check canary path
          if [ "${{ needs.rollout-100.result }}" = "success" ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "path=canary" >> "$GITHUB_OUTPUT"
          # Check direct path
          elif [ "${{ needs.smoke-tests-direct.result }}" = "success" ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "path=direct" >> "$GITHUB_OUTPUT"
          # Check if one path was skipped (the other succeeded)
          elif [ "${{ needs.rollout-100.result }}" = "skipped" ] && [ "${{ needs.smoke-tests-direct.result }}" = "success" ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "path=direct" >> "$GITHUB_OUTPUT"
          elif [ "${{ needs.smoke-tests-direct.result }}" = "skipped" ] && [ "${{ needs.rollout-100.result }}" = "success" ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
            echo "path=canary" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
            echo "path=unknown" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify Slack on success
        if: steps.result.outputs.status == 'success' && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d "{
              \"text\": \":rocket: Production deployment successful\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \":rocket: *Production deployment successful*\n*Cloud:* \`${{ vars.CLOUD_PROVIDER }}\`\n*Image:* \`${{ inputs.image_tag }}\`\n*Path:* ${{ steps.result.outputs.path }}\n*Triggered by:* ${{ github.actor }}\n*URL:* <https://app.qualisys.io|app.qualisys.io>\n*Run:* <${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|View>\"
                  }
                }
              ]
            }"

      - name: Notify Slack on failure
        if: steps.result.outputs.status == 'failure' && secrets.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            -d "{
              \"text\": \":rotating_light: Production deployment FAILED\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \":rotating_light: *Production deployment FAILED*\n*Cloud:* \`${{ vars.CLOUD_PROVIDER }}\`\n*Image:* \`${{ inputs.image_tag }}\`\n*Triggered by:* ${{ github.actor }}\n*URL:* <https://app.qualisys.io|app.qualisys.io>\n*Run:* <${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|View logs>\"
                  }
                }
              ]
            }"
